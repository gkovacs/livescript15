function Scope(t,e){this.parent=t,this.shared=e,this.variables={}}function YES(){return!0}function NO(){return!1}function THIS(){return this}function VOID(){}function util(t){return Scope.root.assign(t+"$",UTILS[t])}function entab(t,e){return t.replace(/\n/g,"\n"+e)}function import$(t,e){var n={}.hasOwnProperty;for(var i in e)n.call(e,i)&&(t[i]=e[i]);return t}function clone$(t){function e(){}return e.prototype=t,new e}function extend$(t,e){function n(){}return n.prototype=(t.superclass=e).prototype,(t.prototype=new n).constructor=t,"function"==typeof e.extended&&e.extended(t),t}function in$(t,e){for(var n=-1,i=e.length>>>0;++n<i;)if(t===e[n])return!0;return!1}function repeatArray$(t,e){for(var n=[];e>0;(e>>=1)&&(t=t.concat(t)))1&e&&n.push.apply(n,t);return n}function repeatString$(t,e){for(var n="";e>0;(e>>=1)&&(t+=t))1&e&&(n+=t);return n}function importAll$(t,e){for(var n in e)t[n]=e[n];return t}var fold,ref$,nameFromPath,stripString,SourceNode,SourceMapGenerator,sn,snEmpty,snSafe,snRemoveLeft,snAutofill,Node,Negatable,Block,Atom,Literal,Var,Key,Index,Slice,Chain,Call,List,Obj,Prop,Arr,Yield,Unary,Binary,Assign,Import,In,Existence,Fun,Class,Super,Parens,Splat,Jump,Throw,Return,While,For,StepSlice,Try,Switch,Case,If,Label,Cascade,JS,Require,Util,Vars,CopyL,DECLS,UTILS,LEVEL_TOP,LEVEL_PAREN,LEVEL_LIST,LEVEL_COND,LEVEL_OP,LEVEL_CALL,PREC,TAB,ID,SIMPLENUM,slice$=[].slice,toString$={}.toString;fold=require("prelude-ls").fold,ref$=require("./util"),nameFromPath=ref$.nameFromPath,stripString=ref$.stripString,ref$=require("./source-map"),SourceNode=ref$.SourceNode,SourceMapGenerator=ref$.SourceMapGenerator,sn=function(t){var e,n,i,s,r,o;for(null==t&&(t={}),n=[],i=1,s=arguments.length;i<s;++i)n.push(arguments[i]);e=n;try{return r=new SourceNode(t.line,t.column,null,e),r.displayName=t.constructor.displayName,r}catch(t){throw o=t,console.dir(e),o}},snEmpty=function(t){var e,n,i,s;if(t instanceof SourceNode){for(e=0,i=(n=t.children).length;e<i;++e)if(s=n[e],!snEmpty(s))return!1;return!0}return!t},snSafe=function(t){return t instanceof SourceNode?t:t.toString()},snRemoveLeft=function(t,e){var n,i,s,r;for(n=0,i=t.children.length;n<i;++n)if(s=n,r=t.children[s],r instanceof SourceNode?e=snRemoveLeft(r,e):(r=r.toString(),t.children[s]=r.slice(e),e-=r.length),e<=0)return 0;return e},snAutofill=function(t,e){var n,i,s,r,o;if(null==e&&(e=[]),t instanceof SourceNode){if(t.line){for(n=0,i=e.length;n<i;++n)s=e[n],s.line=t.line,s.column=t.column;e.length=0}else e.push(t);for(n=0,i=(r=t.children).length;n<i;++n)o=r[n],snAutofill(o,e)}return t},SourceNode.prototype.replace=function(){var t,e,n,i;for(e=[],n=0,i=arguments.length;n<i;++n)e.push(arguments[n]);return t=e,new SourceNode(this.line,this.column,this.source,function(){var e,n,i,s,r=[];for(e=0,s=(i=this.children).length;e<s;++e)n=i[e],r.push(n.replace.apply(n,t));return r}.call(this),this.name)},SourceNode.prototype.setFile=function(t){var e,n,i,s,r=[];for(this.source=t,e=0,i=(n=this.children).length;e<i;++e)s=n[e],s instanceof SourceNode&&r.push(s.setFile(t));return r},SourceNode.prototype.toStringWithSourceMap=function(){var t,e,n,i,s,r,o,a,l,c,p,h,u;for(e=[],n=0,i=arguments.length;n<i;++n)e.push(arguments[n]);return t=e,s=function(t,e,n){n.prototype=t.prototype;var i,s=new n,r=t.apply(s,e);return"object"==(i=typeof r)||"function"==i?r||s:s}(SourceMapGenerator,t,function(){}),r=1,o=0,a=[],l="",c="",p="",h="  ",u=function(t){var e,n,i,f,d,m,y,g,v,b=[];if(!(t instanceof SourceNode)){for(c+=p+""+JSON.stringify(t)+"\n",l+=t,m=a[a.length-1],m&&s.addMapping({source:m.source,original:{line:m.line,column:m.column},generated:{line:r,column:o},name:m.name}),n=0,y=t.length;n<y;++n)g=n,v=t.charAt(g),"\n"===v?(o=0,++r,m&&b.push(s.addMapping({source:m.source,original:{line:m.line,column:m.column},generated:{line:r,column:o},name:m.name}))):b.push(++o);return b}c+=p+t.displayName,e=t.line&&"column"in t,e&&(a.push(t),c+="!"),c+=" "+t.line+":"+t.column+" "+r+":"+o+"\n",p+=h;for(n=0,f=(i=t.children).length;n<f;++n)d=i[n],u(d);if(p=p.slice(0,p.length-h.length),e)return a.pop()},u(this),{code:l,map:s,debug:c}},(Node=function(){throw Error("unimplemented")}).prototype={compile:function(t,e){var n,i,s,r,o,a,l;if(n=import$({},t),null!=e&&(n.level=e),i=this.unfoldSoak(n)||this,n.level&&i.isStatement())return i.compileClosure(n);if(s=(i.tab=n.indent,i).compileNode(n),r=i.temps)for(o=0,a=r.length;o<a;++o)l=r[o],n.scope.free(l);return s},compileClosure:function(t){var e,n,i,s,r,o;return(e=this.getJump())&&e.carp("inconvertible statement"),n=Fun([],Block(this)),i=Call(),t.inGenerator&&(n.generator=!0),this.traverseChildren(function(t){switch(t.value){case"this":r=!0;break;case"arguments":s=t.value="args$"}}),r&&(i.args.push(Literal("this")),i.method=".call"),s&&(i.args.push(Literal("arguments")),n.params.push(Var("args$"))),o=Parens(Chain((n.wrapper=!0,n.void=this.void,n),[i]),!0),t.inGenerator&&(o=new Yield("yieldfrom",o)),o.compile(t)},compileBlock:function(t,e){var n;return snEmpty(n=null!=e?e.compile(t,LEVEL_TOP):void 0)?sn(e,"{}"):sn(null,"{\n",n,"\n"+this.tab+"}")},compileSpreadOver:function(t,e,n){var i,s,r,o,a,l,c,p,h;for(i=e instanceof Obj,s=e.items,r=0,o=s.length;r<o;++r)a=r,l=s[r],(c=l instanceof Splat)&&(l=l.it),i&&!c&&(l=l.val),l=n(l),c&&(l=p=Splat(l)),i&&!c?s[a].val=l:s[a]=l;return p||!this.void&&t.level||(h=Block(i?function(){var t,e,n,i,r=[];for(t=0,i=(n=s).length;t<i;++t)e=n[t],r.push(e.val);return r}():s),h.front=this.front,h.void=!0,e=h),e.compile(t,LEVEL_PAREN)},cache:function(t,e,n){var i,s,r;return this.isComplex()?(s=Assign(r=Var(t.scope.temporary()),this),null!=n?(s=s.compile(t,n),e&&t.scope.free(r.value),[s,r.value]):e?[s,(r.temp=!0,r)]:[s,r,[r.value]]):[i=null!=n?this.compile(t,n):this,i]},compileLoopReference:function(t,e,n,i){var s,r,o,a;return this instanceof Var&&t.scope.check(this.value)||this instanceof Unary&&("+"===(s=this.op)||"-"===s)&&-1/0<(s=+this.it.value)&&s<1/0||this instanceof Literal&&!this.isComplex()?(r=this.compile(t,LEVEL_PAREN),!i||this instanceof Var||(r="("+r+")"),[r,r]):(o=Assign(Var(a=t.scope.temporary(e)),this),n||(o.void=!0),[a,o.compile(t,n?LEVEL_CALL:LEVEL_PAREN)])},eachChild:function(t){var e,n,i,s,r,o,a,l,c,p;for(e=0,i=(n=this.children).length;e<i;++e)if(s=n[e],r=this[s])if("length"in r){for(o=0,a=r.length;o<a;++o)if(l=o,c=r[o],p=t(c,s,l))return p}else if(null!=(p=t(r,s)))return p},traverseChildren:function(t,e){var n=this;return this.eachChild(function(i,s,r){var o;return null!=(o=t(i,n,s,r))?o:i.traverseChildren(t,e)})},anaphorize:function(){function t(e){var n;return"that"===e.value||((n=e.aSource)?(n=e[n])?t(n):void 0:e.eachChild(t))}var e,n,i;return this.children=this.aTargets,this.eachChild(t)&&((e=this)[n=this.aSource]instanceof Existence&&(e=e[n],n="it"),"that"!==e[n].value&&(e[n]=Assign(Var("that"),e[n]))),delete this.children,i=this[this.aSource],i.cond=!0,i},carp:function(t,e){throw null==e&&(e=SyntaxError),e(t+" on line "+(this.line||this.traverseChildren(function(t){return t.line})))},delegate:function(t,e){function n(t){this[t]=function(n){return e.call(this,t,n)}}var i,s;for(i=0,s=t.length;i<s;++i)n.call(this,t[i])},children:[],terminator:";",isComplex:YES,isStatement:NO,isAssignable:NO,isCallable:NO,isEmpty:NO,isArray:NO,isString:NO,isRegex:NO,isMatcher:function(){return this.isString()||this.isRegex()},assigns:NO,ripName:VOID,unfoldSoak:VOID,unfoldAssign:VOID,unparen:THIS,unwrap:THIS,maybeKey:THIS,expandSlice:THIS,varName:String,getAccessors:VOID,getCall:VOID,getDefault:VOID,getJump:VOID,invert:function(){return Unary("!",this,!0)},invertCheck:function(t){return t.inverted?this.invert():this},addElse:function(t){return this.else=t,this},makeReturn:function(t,e){var n,i,s,r;return e?(n=this instanceof Arr?(null==this.items[0]||null==this.items[1]&&this.carp("must specify both key and value for object comprehension"),this.items):(i="keyValue$",function(){var t,e,n,o=[];for(t=0,n=(e=[Assign(Var(i),this),Var(i)]).length;t<n;++t)s=t,r=e[t],o.push(Chain(r).add(Index(Literal(s))));return o}.call(this)),Assign(Chain(Var(t)).add(Index(n[0],".",!0)),n[1])):t?Call.make(JS(t+".push"),[this]):Return(this)},show:String,toString:function(t){var e,n;return t||(t=""),e="\n"+t+this.constructor.displayName,(n=this.show())&&(e+=" "+n),this.eachChild(function(n){e+=n.toString(t+TAB)}),e},stringify:function(t){return JSON.stringify(this,null,t)},toJSON:function(){return import$({type:this.constructor.displayName},this)}},exports.parse=function(t){return exports.fromJSON(JSON.parse(t))},exports.fromJSON=function(){function t(e){var n,i,s,r,o,a,l,c=[];if(!e||"object"!=typeof e)return e;if(n=e.type){i=clone$(exports[n].prototype);for(s in e)r=e[s],i[s]=t(r);return i}if(null!=e.length){for(o=0,a=e.length;o<a;++o)l=e[o],c.push(t(l));return c}return e}return t}(),Negatable={show:function(){return this.negated&&"!"},invert:function(){return this.negated=!this.negated,this}},exports.Block=Block=function(t){function e(t){var e=this instanceof n?this:new n;return t||(t=[]),"length"in t?e.lines=t:(e.lines=[],e.add(t)),e}function n(){}var i=extend$((import$(e,t).displayName="Block",e),t).prototype;return n.prototype=i,e.prototype.children=["lines"],e.prototype.toJSON=function(){return delete this.back,t.prototype.toJSON.call(this)},e.prototype.add=function(t){var e,n;switch(t=t.unparen(),!1){case!(e=this.back):e.add(t);break;case!(e=t.lines):(n=this.lines).push.apply(n,e);break;default:this.lines.push(t),n=t.back,delete t.back,(e=n)&&(this.back=e)}return this},e.prototype.prepend=function(){var t;return(t=this.lines).splice.apply(t,[this.neck(),0].concat(slice$.call(arguments))),this},e.prototype.pipe=function(t,e){var n;switch(n="|>"===e?this.lines.pop():t,"Array"!==toString$.call(n).slice(8,-1)&&(n=[n]),e){case"|>":this.lines.push(Call.make(t,n,{pipe:!0}));break;case"<|":this.lines.push(Call.make(this.lines.pop(),n))}return this},e.prototype.unwrap=function(){return 1===this.lines.length?this.lines[0]:this},e.prototype.chomp=function(){var t,e,n;for(t=this.lines,e=t.length;(n=t[--e])&&n.comment;);return t.length=e+1,this},e.prototype.neck=function(){var t,e,n,i,s;for(t=0,e=0,i=(n=this.lines).length;e<i&&(s=n[e],s.comment||s instanceof Literal);++e)++t;return t},e.prototype.isComplex=function(){var t;return this.lines.length>1||(null!=(t=this.lines[0])?t.isComplex():void 0)},i.delegate(["isCallable","isArray","isString","isRegex"],function(t){var e,n;return null!=(e=(n=this.lines)[n.length-1])?e[t]():void 0}),e.prototype.getJump=function(t){var e,n,i,s,r;for(e=0,i=(n=this.lines).length;e<i;++e)if(s=n[e],r=s.getJump(t))return r},e.prototype.makeReturn=function(){var t,e,n,i;return this.chomp(),(t=null!=(i=e=this.lines)[n=i.length-1]?e[n]=(e=e[n]).makeReturn.apply(e,arguments):void 0)&&t instanceof Return&&!t.it&&--this.lines.length,this},e.prototype.compile=function(t,e){var n,i,s,r,o,a,l;if(null==e&&(e=t.level),e)return this.compileExpressions(t,e);for(t.block=this,n=t.indent,i=[],s=0,o=(r=this.lines).length;s<o;++s)a=r[s],a=a.unfoldSoak(t)||a,snEmpty(l=(a.front=!0,a).compile(t,e))||(i.push(n),i.push(l),a.isStatement()||i.push(a.terminator),i.push("\n"));return i.pop(),sn.apply(null,[null].concat(slice$.call(i)))},e.prototype.compileRoot=function(t){var e,n,i,s,r,o,a,l;return e=import$({level:LEVEL_TOP,scope:this.scope=Scope.root=new Scope},t),i=e.saveScope,delete e.saveScope,(n=i)&&(this.scope=Scope.root=e.scope=n.savedScope||(n.savedScope=e.scope)),delete e.filename,e.indent=(i=e.bare,delete e.bare,(s=i)?"":TAB),/^\s*(?:[\/#]|javascript:)/.test(null!=(i=this.lines[0])?i.code:void 0)&&(r=this.lines.shift().code+"\n"),o=e.eval,delete e.eval,o&&this.chomp().lines.length&&(s?this.lines.push(Parens(this.lines.pop())):this.makeReturn()),a=[this.compileWithDeclarations(e)],s||(a=["(function(){\n"].concat(slice$.call(a),["\n}).call(this);\n"])),l=sn.apply(null,[null,r||[]].concat(slice$.call(a)))},e.prototype.compileWithDeclarations=function(t){var e,n,i,s,r;return t.level=LEVEL_TOP,e=[],(n=this.neck())&&(i=this.lines.splice(n,9e9),e=[this.compile(t),"\n"],this.lines=i),snEmpty(s=this.compile(t))?sn(this,e[0]||[]):sn.apply(null,[null].concat(slice$.call(e),[(r=this.scope)?r.emit(s,t.indent):s]))},e.prototype.compileExpressions=function(t,e){var n,i,s,r,o,a,l,c;for(n=this.chomp().lines,i=-1;s=n[++i];)s.comment&&n.splice(i--,1);if(n.length||n.push(Literal("void")),n[0].front=this.front,n[n.length-1].void=this.void,!n[1])return n[0].compile(t,e);for(r=[],o=n.pop(),a=0,l=n.length;a<l;++a)c=n[a],r.push((c.void=!0,c).compile(t,LEVEL_PAREN),", ");return r.push(o.compile(t,LEVEL_PAREN)),e<LEVEL_LIST?sn.apply(null,[null].concat(slice$.call(r))):sn.apply(null,[null,"("].concat(slice$.call(r),[")"]))},e}(Node),Atom=function(t){function e(){e.superclass.apply(this,arguments)}return extend$((import$(e,t).displayName="Atom",e),t).prototype,e.prototype.show=function(){return this.value},e.prototype.isComplex=NO,e}(Node),exports.Literal=Literal=function(t){function e(t){var e=this instanceof n?this:new n;return e.value=t,t.js?JS(t+"",!0):"super"===t?new Super:e}function n(){}var i=extend$((import$(e,t).displayName="Literal",e),t).prototype;return n.prototype=i,e.prototype.isEmpty=function(){var t;return"void"===(t=this.value)||"null"===t},e.prototype.isCallable=function(){var t;return"this"===(t=this.value)||"eval"===t||".."===t},e.prototype.isString=function(){return 0<="'\"".indexOf((this.value+"").charAt())},e.prototype.isRegex=function(){return"/"===(this.value+"").charAt()},e.prototype.isComplex=function(){return this.isRegex()||"debugger"===this.value},e.prototype.isWhat=function(){switch(!1){case!this.isEmpty():return"empty";case!this.isCallable():return"callable";case!this.isString():return"string";case!this.isRegex():return"regex";case!this.isComplex():return"complex"}},e.prototype.varName=function(){return/^\w+$/.test(this.value)?"$"+this.value:""},e.prototype.makeReturn=function(e){return e||"debugger"!==this.value?t.prototype.makeReturn.apply(this,arguments):this},e.prototype.maybeKey=function(){return ID.test(this.value)?Key(this.value):this},e.prototype.compile=function(t,e){var n,i;switch(null==e&&(e=t.level),n=this.value+""){case"this":return sn(this,(null!=(i=t.scope.fun)?i.bound:void 0)||n);case"void":if(!e)return sn(this,"");n+=" 8";case"null":e===LEVEL_CALL&&this.carp("invalid use of "+this.value);break;case"on":case"yes":n="true";break;case"off":case"no":n="false";break;case"*":this.carp("stray star");break;case"..":(n=t.ref)||this.carp("stray reference"),this.cascadee||(n.erred=!0);break;case"debugger":if(e)return sn(this,"(function(){ debugger; }())")}return sn(this,snSafe(n))},e}(Atom),exports.Var=Var=function(t){function e(t){var e=this instanceof n?this:new n;return e.value=t,e}function n(){}var i=extend$((import$(e,t).displayName="Var",e),t).prototype;return n.prototype=i,i.isAssignable=i.isCallable=YES,e.prototype.assigns=function(t){return t===this.value},e.prototype.maybeKey=function(){var t;return t=Key(this.value),t.line=this.line,t},e.prototype.varName=i.show,e.prototype.compile=function(t){return sn(this,this.temp?t.scope.free(this.value):this.value)},e}(Atom),exports.Key=Key=function(t){function e(t,e){var i=this instanceof n?this:new n;return i.reserved=e||t.reserved,i.name=""+t,i}function n(){}var i=extend$((import$(e,t).displayName="Key",e),t).prototype;return n.prototype=i,e.prototype.isComplex=NO,e.prototype.assigns=function(t){return t===this.name},e.prototype.varName=function(){var t;return t=this.name,this.reserved||"arguments"===t||"eval"===t?"$"+t:t},e.prototype.show=function(){return this.reserved?"'"+this.name+"'":this.name},e.prototype.compile=function(){return sn(this,this.show())},e}(Node),exports.Index=Index=function(t){function e(t,e,i){var s,r=this instanceof n?this:new n;if(e||(e="."),i&&t instanceof Arr)switch(t.items.length){case 1:(s=t.items[0])instanceof Splat||(t=Parens(s))}switch(e){case"[]":r.vivify=Arr;break;case"{}":r.vivify=Obj;break;default:"="===e.slice(-1)&&(r.assign=e.slice(1))}return r.key=t,r.symbol=e,r}function n(){}var i=extend$((import$(e,t).displayName="Index",e),t).prototype;return n.prototype=i,e.prototype.children=["key"],e.prototype.show=function(){return[this.soak?"?":void 0]+this.symbol},e.prototype.isComplex=function(){return this.key.isComplex()},e.prototype.varName=function(){var t;return((t=this.key)instanceof Key||t instanceof Literal)&&this.key.varName()},e.prototype.compile=function(t){var e;return e=this.key.compile(t,LEVEL_PAREN),this.key instanceof Key&&"'"!==e.toString().charAt(0)?sn(this,".",e):sn(this,"[",e,"]")},e}(Node),exports.Slice=Slice=function(t){function e(t){var e=this instanceof n?this:new n;return e.type=t.type,e.target=t.target,e.from=t.from,e.to=t.to,null==e.from&&(e.from=Literal(0)),e.to&&"to"===e.type&&(e.to=Binary("+",e.to,Literal("1"))),e}function n(){}var i=extend$((import$(e,t).displayName="Slice",e),t).prototype;return n.prototype=i,e.prototype.children=["target","from","to"],e.prototype.show=function(){return this.type},e.prototype.compileNode=function(t){var e;return this.to&&"to"===this.type&&(this.to=Binary("||",this.to,Literal("9e9"))),e=[this.target,this.from],this.to&&e.push(this.to),Chain(Var(util("slice"))).add(Index(Key("call"),".",!0)).add(Call(e)).compile(t)},e}(Node),exports.Chain=Chain=function(t){function e(t,i){var s=this instanceof n?this:new n;return!i&&t instanceof e?t:(s.head=t,s.tails=i||[],s)}function n(){}var i=extend$((import$(e,t).displayName="Chain",e),t).prototype;return n.prototype=i,e.prototype.children=["head","tails"],e.prototype.add=function(t){var n,i,s,r,o,a,l,c;if(this.tails.length&&(n=(i=this.tails)[i.length-1],n instanceof Call&&1===(null!=(i=n.partialized)?i.length:void 0)&&1===t.args.length))return s=n.partialized[0].head.value,delete n.partialized,n.args[s]=t.args[0],this;if(this.head instanceof Existence&&(r=e(this.head.it),this.head=r.head,this.tails=r.tails,t.soak=!0),this.tails.push(t),o=this.head instanceof Parens&&this.head.it instanceof Binary&&!this.head.it.partial?this.head.it:this.head instanceof Binary&&!this.head.partial?this.head:void 0,this.head instanceof Super)!this.head.called&&t instanceof Call&&!t.method?(t.method=".call",t.args.unshift(Literal("this")),this.head.called=!0):this.tails[1]||"prototype"!==(null!=(r=t.key)?r.name:void 0)||(this.head.sproto=!0);else if(t instanceof Call&&1===this.tails.length&&o&&in$(o.op,a=["&&","||","xor"]))return l=t,c=function(t,n){var i;return i=t[n],i instanceof Binary&&in$(i.op,a)?(c(i,"first"),c(i,"second")):t[n]=e(i).autoCompare(l.args)},c(o,"first"),c(o,"second"),o;return this},e.prototype.autoCompare=function(t){var e;switch(e=this.head,!1){case!(e instanceof Literal):return Binary("===",e,t[0]);case!(e instanceof Unary&&e.it instanceof Literal):return Binary("===",e,t[0]);case!(e instanceof Arr||e instanceof Obj):return Binary("====",e,t[0]);case!(e instanceof Var&&"_"===e.value):return Literal("true");default:return this.add(Call(t))||[]}},e.prototype.flipIt=function(){return this.flip=!0,this},e.prototype.unwrap=function(){return this.tails.length?this:this.head},i.delegate(["getJump","assigns","isStatement","isString"],function(t,e){return!this.tails.length&&this.head[t](e)}),e.prototype.isComplex=function(){return this.tails.length||this.head.isComplex()},e.prototype.isCallable=function(){var t,e;return(t=(e=this.tails)[e.length-1])?!(null!=(e=t.key)&&e.items):this.head.isCallable()},e.prototype.isArray=function(){var t,e;return(t=(e=this.tails)[e.length-1])?t.key instanceof Arr:this.head.isArray()},e.prototype.isRegex=function(){return"RegExp"===this.head.value&&!this.tails[1]&&this.tails[0]instanceof Call},e.prototype.isAssignable=function(){var t,e,n,i;if(!(t=(e=this.tails)[e.length-1]))return this.head.isAssignable();if(!(t instanceof Index)||t.key instanceof List||".~"===t.symbol)return!1;for(n=0,i=(e=this.tails).length;n<i;++n)if(t=e[n],t.assign)return!1;return!0},e.prototype.isSimpleAccess=function(){return 1===this.tails.length&&!this.head.isComplex()&&!this.tails[0].isComplex()},e.prototype.makeReturn=function(){var e;return this.tails.length?t.prototype.makeReturn.apply(this,arguments):(e=this.head).makeReturn.apply(e,arguments)},e.prototype.getCall=function(){var t,e;return(t=(e=this.tails)[e.length-1])instanceof Call&&t},e.prototype.varName=function(){var t,e;return null!=(t=(e=this.tails)[e.length-1])?t.varName():void 0},e.prototype.cacheReference=function(t){var n,i,s,r,o,a;return n=(i=this.tails)[i.length-1],this.isAssignable()?!(this.tails.length<2)||this.head.isComplex()||null!=n&&n.isComplex()?(s=e(this.head,this.tails.slice(0,-1)),s.isComplex()&&(r=t.scope.temporary(),s=e(Assign(Var(r),s)),i=Var(r),i.temp=!0,o=i),n?(n.isComplex()&&(r=t.scope.temporary("key"),n=Index(Assign(Var(r),n.key)),a=Index((i=Var(r),i.temp=!0,i))),[s.add(n),e(o||s.head,[a||n])]):[s,o]):[this,this]:this.unwrap().cache(t,!0)},e.prototype.compileNode=function(t){var n,i,s,r,o,a,l,c,p,h,u,f,d,m,y,g,v,b;if(this.flip&&(util("flip"),util("curry")),n=this.head,i=this.tails,n.front=this.front,n.newed=this.newed,!i.length)return n.compile(t);if(s=this.unfoldAssign(t))return s.compile(t);for(r=0,o=i.length;r<o;++r)if(a=i[r],a.partialized){l=!0;break}if(l){for(util("slice"),c=[],p=[],r=0,o=i.length;r<o;++r)a=i[r],h=h||null!=a.partialized,h?p.push(a):c.push(a);return null!=p&&(u=p[0],f=slice$.call(p,1)),this.tails=c,d=c.length?e(n,slice$.call(c,0,-1)):Literal("this"),e(e(Var(util("partialize"))).add(Index(Key("apply"))).add(Call([d,Arr([this,Arr(u.args),Arr(u.partialized)])])),f).compile(t)}if(i[0]instanceof Call&&!n.isCallable()&&this.carp("invalid callee"),this.expandSlice(t),this.expandVivify(),this.expandBind(t),this.expandSplat(t),this.expandStar(t),this.splattedNewArgs)return m=t.indent+TAB,y=e(this.head,i.slice(0,-1)),sn(null,"(function(func, args, ctor) {\n"+m+"ctor.prototype = func.prototype;\n"+m+"var child = new ctor, result = func.apply(child, args), t;\n"+m+'return (t = typeof result)  == "object" || t == "function" ? result || child : child;\n'+TAB+"})(",y.compile(t),", ",this.splattedNewArgs,", function(){})");if(!this.tails.length)return this.head.compile(t);for(g=[this.head.compile(t,LEVEL_CALL)],v=[],p=[],r=0,o=(b=this.tails).length;r<o;++r)a=b[r],a.new&&v.push("new "),p.push(a.compile(t));return"."===p.join("").charAt(0)&&SIMPLENUM.test(g[0].toString())&&g.push(" "),sn.apply(null,[null].concat(slice$.call(v),slice$.call(g),slice$.call(p)))},e.prototype.unfoldSoak=function(t){var n,i,s,r,o,a,l,c,p;if(n=this.head.unfoldSoak(t))return(i=n.then.tails).push.apply(i,this.tails),n;for(s=0,r=(i=this.tails).length;s<r;++s)if(o=s,a=i[s],l=a.soak,delete a.soak,l)return c=e(this.head,this.tails.splice(0,o)),a.assign&&!c.isAssignable()&&a.carp("invalid accessign"),o&&(a.assign||a instanceof Call)?(l=c.cacheReference(t),p=l[0],c=l[1],c instanceof e&&((l=this.tails).unshift.apply(l,c.tails),c=c.head),this.head=c):(l=c.unwrap().cache(t),p=l[0],this.head=l[1]),p=a instanceof Call?JS("typeof "+p.compile(t,LEVEL_OP)+" == 'function'"):Existence(p),l=If(p,this),l.soak=!0,l.cond=this.cond,l.void=this.void,l},e.prototype.unfoldAssign=function(t){var n,i,s,r,o,a,l,c,p,h,u,f,d,m;if(n=this.head.unfoldAssign(t))return(i=n.right.tails).push.apply(i,this.tails),n;for(s=0,r=(i=this.tails).length;s<r;++s)if(o=s,a=i[s],l=a.assign){if(a.assign="",c=e(this.head,this.tails.splice(0,o)).expandSlice(t).unwrap(),c instanceof Arr)for(p=c.items,h=(this.head=Arr()).items,u=0,f=p.length;u<f;++u)o=u,d=p[u],m=e(d).cacheReference(t),h[o]=m[0],p[o]=m[1];else m=e(c).cacheReference(t),c=m[0],this.head=m[1];return"="===l&&(l=":="),m=Assign(c,this,l),m.access=!0,m}},e.prototype.expandSplat=function(t){var n,i,s,r,o,a;for(n=this.tails,i=-1;s=n[++i];)(r=s.args)&&(o=".call"===s.method&&(r=r.concat()).shift(),snEmpty(r=Splat.compileArray(t,r,!0))||(s.new?this.splattedNewArgs=r:(!o&&n[i-1]instanceof Index&&(a=e(this.head,n.splice(0,i-1)).cache(t,!0),this.head=a[0],o=a[1],i=0),s.method=".apply",s.args=[o||Literal("null"),JS(r)])))},e.prototype.expandVivify=function(){var t,n,i,s,r;for(t=this.tails,n=0;n<t.length;)r=(s=t[n++]).vivify,delete s.vivify,(i=r)&&(this.head=Assign(e(this.head,t.splice(0,n)),i(),"=","||"),n=0)},e.prototype.expandBind=function(t){var n,i,s,r,o,a;for(n=this.tails,i=-1;s=n[++i];)".~"===s.symbol&&(s.symbol="",r=e(this.head,n.splice(0,i)).unwrap(),o=n.shift().key,a=Call.make(Util("bind"),[r,(o.reserved=!0,o)]),this.head=this.newed?Parens(a,!0):a,i=-1)},e.prototype.expandStar=function(t){function n(t){"*"===t.value?o.push(t):t instanceof Index||t.eachChild(n)}var i,s,r,o,a,l,c,p,h,u,f,d;for(i=this.tails,s=-1;r=i[++s];)if(!(r.args||r.stars||r.key instanceof Key)&&(o=r.stars=[],r.eachChild(n),o.length)){for(a=e(this.head,i.splice(0,s)).unwrap().cache(t),l=a[0],c=a[1],p=a[2],h=e(c,[Index(Key("length"))]).compile(t),u=0,f=o.length;u<f;++u)d=o[u],d.value=h,d.isAssignable=YES;this.head=JS(l.compile(t,LEVEL_CALL)+i.shift().compile(t)),p&&t.scope.free(p[0]),s=-1}},e.prototype.expandSlice=function(t,n){var i,s,r,o,a;for(i=this.tails,s=-1;r=i[++s];)null!=(o=r.key)&&o.items&&(i[s+1]instanceof Call&&r.carp("calling a slice"),a=i.splice(0,s+1),a=a.pop().key.toSlice(t,e(this.head,a).unwrap(),r.symbol,n),this.head=(a.front=this.front,a),s=-1);return this},e}(Node),exports.Call=Call=function(t){function e(t){var e,i,s,r,o,a,l=this instanceof n?this:new n;if(t||(t=[]),1===t.length&&(e=t[0])instanceof Splat)e.filler?(l.method=".call",t[0]=Literal("this"),t[1]=Splat(Literal("arguments"))):e.it instanceof Arr&&(t=e.it.items);else for(i=0,s=t.length;i<s;++i)r=i,o=t[i],"_"===o.value&&(t[r]=Chain(Literal("void")),t[r].placeholder=!0,(null!=(a=l.partialized)?a:l.partialized=[]).push(Chain(Literal(r))));return l.args=t,l}function n(){}var i=extend$((import$(e,t).displayName="Call",e),t).prototype;return n.prototype=i,e.prototype.children=["args"],e.prototype.show=function(){return[this.new]+[this.method]+[this.soak?"?":void 0]},e.prototype.compile=function(t){var e,n,i,s,r,o;for(e=[sn(this,this.method||"","(")+(this.pipe?"\n"+t.indent:"")],n=0,s=(i=this.args).length;n<s;++n)r=n,o=i[n],e.push(r?", ":"",o.compile(t,LEVEL_LIST));return e.push(sn(this,")")),sn.apply(null,[null].concat(slice$.call(e)))},e.make=function(t,n,i){var s;return s=e(n),i&&import$(s,i),Chain(t).add(s)},e.block=function(t,n,i){var s,r;return s=Parens(Chain(t,[(r=e(n),r.method=i,r)]),!0),s.calling=!0,s},e.back=function(t,n,i,s,r,o){var a,l,c,p,h,u,f;for(a=Fun(t,void 0,i,s,r,o),n instanceof Label&&(a.name=n.label,a.labeled=!0,n=n.it),!a.hushed&&(a.hushed="!"===n.op)&&(n=n.it),null!=(l=n.getCall())&&(l.partialized=null),c=(n.getCall()||(n=Chain(n).add(e())).getCall()).args,p=0,h=0,u=c.length;h<u&&(f=c[h],!f.placeholder);++h)++p;return n.back=(c[p]=a).body,n},e.let=function(t,e,n){var i,s,r,o,a,l,c,p;for(null==n&&(n=!1),s=[],r=0,o=t.length;r<o;++r)if(a=r,l=t[r],c="="===l.op&&!l.logic&&l.right){if(t[a]=c,0===a&&(p="this"===l.left.value))continue;s.push(l.left)}else s.push(Var(l.varName()||l.carp('invalid "let" argument')));return i=s,p||t.unshift(Literal("this")),this.block(Fun(i,e,null,null,null,n),t,".call")},e}(Node),List=function(t){function e(){e.superclass.apply(this,arguments)}return extend$((import$(e,t).displayName="List",e),t).prototype,e.prototype.children=["items"],e.prototype.show=function(){return this.name},e.prototype.named=function(t){return this.name=t,this},e.prototype.isEmpty=function(){return!this.items.length},e.prototype.assigns=function(t){var e,n,i,s;for(e=0,i=(n=this.items).length;e<i;++e)if(s=n[e],s.assigns(t))return!0},e.compile=function(t,e,n){var i,s,r,o,a,l;switch(e.length){case 0:return"";case 1:return e[0].compile(t,LEVEL_LIST)}for(i=t.indent,s=t.level,t.indent=i+TAB,t.level=LEVEL_LIST,r=[e[o=0].compile(t)];a=e[++o];)r.push(", "),l=a,n&&(l instanceof Var&&"_"===l.value?l=Obj([Prop(Key("__placeholder__"),Literal(!0))]):(l instanceof Obj||l instanceof Arr)&&(l.deepEq=!0)),r.push(l.compile(t));return~r.join("").indexOf("\n")&&(r=["\n"+t.indent].concat(slice$.call(r),["\n"+i])),t.indent=i,t.level=s,sn.apply(null,[this].concat(slice$.call(r)))},e}(Node),exports.Obj=Obj=function(t){function e(t){var e=this instanceof n?this:new n;return e.items=t||[],e}function n(){}var i=extend$((import$(e,t).displayName="Obj",e),t).prototype;return n.prototype=i,e.prototype.asObj=THIS,e.prototype.toSlice=function(t,e,n,i){var s,r,o,a,l,c,p,h,u,f,d,m,y;for(s=this.items,s.length>1?(r=e.cache(t),e=r[0],o=r[1],a=r[2]):o=e,l=0,c=s.length;l<c;++l)p=l,h=s[l],h.comment||(h instanceof Prop||h instanceof Splat?h[u=(r=h.children)[r.length-1]]=f=Chain(e,[Index(h[u].maybeKey())]):((d=h.getDefault())&&(h=h.first),h instanceof Parens?(r=h.cache(t,!0),m=r[0],h=r[1],i&&(r=[h,m],m=r[0],h=r[1]),m=Parens(m)):m=h,y=f=Chain(e,[Index(h.maybeKey(),n)]),d&&(d.first=y,y=d),s[p]=Prop(m,y)),e=o);return f||this.carp("empty slice"),a&&((f.head=Var(a[0])).temp=!0),this},e.prototype.compileNode=function(t){var n,i,s,r,o,a,l,c,p,h,u,f,d,m;if(n=this.items,!n.length)return sn(this,this.front?"({})":"{}");for(i=[],s="\n"+(t.indent+=TAB),r={},o=0,a=n.length;o<a;++o)if(l=o,c=n[o],c.comment)i.push(s,c.compile(t));else{if((p=c.getDefault())&&(c=c.first),c instanceof Splat||(c.key||c)instanceof Parens){h=n.slice(l);break}p&&(c instanceof Prop?c.val=(p.first=c.val,p):c=Prop(c,(p.first=c,p))),this.deepEq&&c instanceof Prop&&(c.val instanceof Var&&"_"===c.val.value?c.val=e([Prop(Key("__placeholder__"),Literal(!0))]):((u=c.val)instanceof e||u instanceof Arr)&&(c.val.deepEq=!0)),f?i.push(","):f=!0,i.push(s),c instanceof Prop?(d=c.key,m=c.val,c.accessor?i.push(c.compileAccessor(t,d=d.compile(t))):(m.ripName(d),i.push(d=d.compile(t),": ",m.compile(t,LEVEL_LIST)))):i.push(d=c.compile(t),": ",d),ID.test(d)||(d=Function("return "+d)()),(r[d+"."]^=1)||c.carp('duplicate property "'+d+'"')}return i.join("")&&i.push("\n"+this.tab),i=sn.apply(null,[null,sn(this,"{")].concat(slice$.call(i),[sn(this,"}")])),h&&(i=Import(JS(i),e(h)).compile((t.indent=this.tab,t))),this.front&&"{"===i.toString().charAt()?sn(null,"(",i,")"):i},e}(List),exports.Prop=Prop=function(t){function e(t,e){var i,s,r,o,a=this instanceof n?this:new n;if(a.key=t,a.val=e,"..."===t.value)return Splat(a.val);if(i=e.getAccessors()){for(a.val=i,s=0,r=i.length;s<r;++s)o=i[s],o.x=(o.hushed=o.params.length)?"s":"g";a.accessor="accessor"}return a}function n(){}var i=extend$((import$(e,t).displayName="Prop",e),t).prototype;return n.prototype=i,e.prototype.children=["key","val"],e.prototype.show=function(){return this.accessor},e.prototype.assigns=function(t){var e;return"function"==typeof(e=this.val).assigns?e.assigns(t):void 0},e.prototype.compileAccessor=function(t,e){var n,i,s,r,o;for(n=this.val,n[1]&&n[0].params.length+n[1].params.length!==1&&n[0].carp("invalid accessor parameter"),i=[],s=0,r=n.length;s<r;++s)o=n[s],o.accessor=!0,i.push(o.x,"et ",e,o.compile(t,LEVEL_LIST).toString().slice(8),",\n"+t.indent);return i.pop(),sn.apply(null,[null].concat(slice$.call(i)))},e.prototype.compileDescriptor=function(t){var n,i,s,r,o;for(n=Obj(),i=0,r=(s=this.val).length;i<r;++i)o=s[i],n.items.push(e(Key(o.x+"et"),o));return n.items.push(e(Key("configurable"),Literal(!0))),n.items.push(e(Key("enumerable"),Literal(!0))),n.compile(t)},e}(Node),exports.Arr=Arr=function(t){function e(t){var e=this instanceof n?this:new n;return e.items=t||[],e}function n(){}var i=extend$((import$(e,t).displayName="Arr",e),t).prototype,s=e;return n.prototype=i,e.prototype.isArray=YES,e.prototype.asObj=function(){var t,e;return Obj(function(){var n,i,s,r=[];for(n=0,s=(i=this.items).length;n<s;++n)t=n,e=i[n],r.push(Prop(Literal(t),e));return r}.call(this))},e.prototype.toSlice=function(t,e,n){var i,s,r,o,a,l,c,p,h;for(i=this.items,i.length>1?(s=e.cache(t),e=s[0],r=s[1]):r=e,o=0,a=i.length;o<a;++o)l=o,c=i[o],(p=c instanceof Splat)&&(c=c.it),c.isEmpty()||(h=Chain(e,[Index(c,n)]),i[l]=p?Splat(h):h,e=r);return h||this.carp("empty slice"),this},e.prototype.compile=function(t){var e,n;return e=this.items,e.length?snEmpty(n=Splat.compileArray(t,e))?sn(null,sn(this,"["),List.compile(t,e,this.deepEq),sn(this,"]")):this.newed?sn(this,"(",n,")"):sn(this,n):sn(this,"[]");
},e.maybe=function(t){return 1!==t.length||t[0]instanceof Splat?s(t):t[0]},e.wrap=function(t){return s([Splat((t.isArray=YES,t))])},e}(List),exports.Yield=Yield=function(t){function e(t,e){var i=this instanceof n?this:new n;return i.op=t,i.it=e,i}function n(){}var i=extend$((import$(e,t).displayName="Yield",e),t).prototype;return n.prototype=i,e.prototype.children=["it"],e.prototype.show=function(){return"yieldfrom"===this.op?"from":""},i.delegate(["isCallable"],function(){return!0}),e.prototype.compileNode=function(t){var e;return e=[],"yieldfrom"===this.op?e.push("yield*"):e.push("yield"),this.it&&e.push(" "+this.it.compile(t,LEVEL_OP+PREC.unary)),sn.apply(null,[this,"("].concat(slice$.call(e),[")"]))},e}(Node),exports.Unary=Unary=function(t){function e(t,e,i){var s,r,o,a,l,c=this instanceof n?this:new n;if(null!=e){if(s=!i&&e.unaries)return s.push(t),e;switch(t){case"!":if(i)break;return e instanceof Fun&&!e.hushed?(e.hushed=!0,e):e.invert();case"++":case"--":i&&(c.post=!0);break;case"new":for(e instanceof Existence&&!e.negated&&(e=Chain(e).add(Call())),e.newed=!0,r=0,a=(o=e.tails||"").length;r<a;++r)if(l=o[r],l instanceof Call&&!l.new)return".call"===l.method&&l.args.shift(),l.new="new",l.method="",e;break;case"~":if(e instanceof Fun&&e.statement&&!e.bound)return e.bound="this$",e}}return c.op=t,c.it=e,c}function n(){}function i(t){return{"++":"in","--":"de"}[t]+"crement"}var s=extend$((import$(e,t).displayName="Unary",e),t).prototype,r=e;return n.prototype=s,e.prototype.children=["it"],e.prototype.show=function(){return[this.post?"@":void 0]+this.op},e.prototype.isCallable=function(){var t;return"do"===(t=this.op)||"new"===t||"delete"===t||null==this.it},e.prototype.isArray=function(){return this.it instanceof Arr&&this.it.items.length||this.it instanceof Chain&&this.it.isArray()},e.prototype.isString=function(){var t;return"typeof"===(t=this.op)||"classof"===t},e.prototype.invert=function(){var t;return"!"!==this.op||"!"!==(t=this.it.op)&&"<"!==t&&">"!==t&&"<="!==t&&">="!==t&&"of"!==t&&"instanceof"!==t?r("!",this,!0):this.it},e.prototype.unfoldSoak=function(t){var e;return("++"===(e=this.op)||"--"===e||"delete"===e)&&null!=this.it&&If.unfoldSoak(t,this,"it")},e.prototype.getAccessors=function(){var t;if("~"===this.op)return this.it instanceof Fun?[this.it]:this.it instanceof Arr&&(t=this.it.items,!t[2]&&t[0]instanceof Fun&&t[1]instanceof Fun)?t:void 0},e.prototype.compileNode=function(t){var n,s,r,o,a;if(null==this.it)return this.compileAsFunc(t);if(n=this.compileSpread(t))return n;switch(s=this.op,r=this.it,s){case"!":r.cond=!0;break;case"new":r.isCallable()||r.carp("invalid constructor");break;case"do":return t.level===LEVEL_TOP&&r instanceof Fun&&r.isStatement()?sn(this,r.compile(t)," ",e("do",Var(r.name)).compile(t)):(o=Parens(r instanceof Existence&&!r.negated?Chain(r).add(Call()):Call.make(r)),sn(this,(o.front=this.front,o.newed=this.newed,o).compile(t)));case"delete":if((r instanceof Var||!r.isAssignable())&&this.carp("invalid delete"),t.level&&!this.void)return this.compilePluck(t);break;case"++":case"--":r.isAssignable()||this.carp("invalid "+i(s)),(n=r instanceof Var&&t.scope.checkReadOnly(r.value))&&this.carp(i(s)+" of "+n+' "'+r.value+'"',ReferenceError),this.post&&(r.front=this.front);break;case"^^":return sn(this,util("clone"),"(",r.compile(t,LEVEL_LIST),")");case"jsdelete":return sn(this,"delete ",r.compile(t,LEVEL_LIST));case"classof":return sn(this,util("toString"),".call(",r.compile(t,LEVEL_LIST),").slice(8, -1)")}return a=[r.compile(t,LEVEL_OP+PREC.unary)],this.post?a.push(s):("new"!==s&&"typeof"!==s&&"delete"!==s&&("+"!==s&&"-"!==s||s!==a.join("").charAt())||(s+=" "),a.unshift(s)),t.level<LEVEL_CALL?sn.apply(null,[this].concat(slice$.call(a))):sn.apply(null,[this,"("].concat(slice$.call(a),[")"]))},e.prototype.compileSpread=function(t){var e,n;for(e=this.it,n=[this];e instanceof r;e=e.it)n.push(e);return e instanceof Splat&&(e=e.it.expandSlice(t).unwrap())instanceof List?this.compileSpreadOver(t,e,function(t){var e,i,s;for(e=(i=n).length-1;e>=0;--e)s=i[e],t=r(s.op,t,s.post);return t}):""},e.prototype.compilePluck=function(t){var e,n,i,s,r;return e=Chain(this.it).cacheReference(t),n=e[0],i=e[1],s=[r=t.scope.temporary()," = ",n.compile(t,LEVEL_LIST),", delete ",i.compile(t,LEVEL_LIST),", ",t.scope.free(r)],t.level<LEVEL_LIST?sn.apply(null,[this].concat(slice$.call(s))):sn.apply(null,[this,"("].concat(slice$.call(s),[")"]))},e.prototype.compileAsFunc=function(t){return"!"===this.op?sn(this,util("not")):sn(this,"(",Fun([],Block(e(this.op,Chain(Var("it"))))).compile(t),")")},e}(Node),exports.Binary=Binary=function(t){function e(t,e,i,s){var r,o,a,l=this instanceof n?this:new n;if(s&&(r=t.logic,"String"===toString$.call(s).slice(8,-1)&&(r=s),t=function(){switch(!1){case!(o=r):return o;case"="!==t:return"?";default:return"="}}()),l.partial=null==e||null==i,!l.partial){if("="===t.charAt(t.length-1)&&"="!==(a=t.charAt(t.length-2))&&"<"!==a&&">"!==a&&"!"!==a)return Assign(e.unwrap(),i,t);switch(t){case"in":return new In(e,i);case"with":return new Import(Unary("^^",e),i,!1);case"<<<":case"<<<<":return Import(e,i,"<<<<"===t);case"<|":return Block(e).pipe(i,t);case"|>":return Block(i).pipe(e,"<|");case".":case".~":return Chain(e).add(Index(i,t))}}return l.op=t,l.first=e,l.second=i,l}function n(){}var i,s,r=extend$((import$(e,t).displayName="Binary",e),t).prototype;return n.prototype=r,e.prototype.children=["first","second"],e.prototype.show=function(){return this.op},e.prototype.isCallable=function(){var t;return this.partial||("&&"===(t=this.op)||"||"===t||"?"===t||"<<"===t||">>"===t)&&this.first.isCallable()&&this.second.isCallable()},e.prototype.isArray=function(){switch(this.op){case"*":return this.first.isArray();case"/":return this.second.isMatcher()}},e.prototype.isString=function(){switch(this.op){case"+":case"*":return this.first.isString()||this.second.isString();case"-":return this.second.isMatcher()}},i=/^(?:[!=]=|[<>])=?$/,s={"===":"!==","!==":"===","==":"!=","!=":"=="},e.prototype.invert=function(){var t;return(t=!i.test(this.second.op)&&s[this.op])?(this.op=t,this.wasInverted=!0,this):Unary("!",Parens(this),!0)},e.prototype.invertIt=function(){return this.inverted=!0,this},e.prototype.getDefault=function(){switch(this.op){case"?":case"||":case"&&":return this}},e.prototype.xorChildren=function(t){var e,n,i;return!(!(e=i=t(this.first))==!(n=t(this.second))||!e&&!n)&&(i?[this.first,this.second]:[this.second,this.first])},e.prototype.compileNode=function(t){var e,n,s,r,o,a,l;if(this.partial)return this.compilePartial(t);switch(this.op){case"?":return this.compileExistence(t);case"*":if(this.second.isString())return this.compileJoin(t);if(this.first.isString()||this.first.isArray())return this.compileRepeat(t);break;case"-":if(this.second.isMatcher())return this.compileRemove(t);break;case"/":if(this.second.isMatcher())return this.compileSplit(t);break;case"**":case"^":return this.compilePow(t);case"<?":case">?":return this.compileMinMax(t);case"<<":case">>":return this.compileCompose(t);case"++":return this.compileConcat(t);case"%%":return this.compileMod(t);case"xor":return this.compileXor(t);case"&&":case"||":(e=this.void||!t.level)&&(this.second.void=!0),(e||this.cond)&&(this.first.cond=!0,this.second.cond=!0);break;case"instanceof":if(n=this.second.expandSlice(t).unwrap(),s=n.items,n instanceof Arr){if(s[1])return this.compileAnyInstanceOf(t,s);this.second=s[0]||n}this.second.isCallable()||this.second.carp("invalid instanceof operand");break;case"====":case"!===":this.op=this.op.slice(0,3);case"<==":case">==":case"<<=":case">>=":return this.compileDeepEq(t);default:if(i.test(this.op)){if(r=("==="===(o=this.op)||"!=="===o)&&this.xorChildren(function(t){return t.isRegex()}))return this.compileRegexEquals(t,r);"==="===this.op&&this.first instanceof Literal&&this.second instanceof Literal&&this.first.isWhat()!==this.second.isWhat()&&"undefined"!=typeof console&&null!==console&&console.warn("WARNING: strict comparison of two different types will always be false: "+this.first.value+" == "+this.second.value)}if(i.test(this.op)&&i.test(this.second.op))return this.compileChain(t)}return this.first.front=this.front,a=[this.first.compile(t,l=LEVEL_OP+PREC[this.op])," ",this.mapOp(this.op)," ",this.second.compile(t,l)],t.level<=l?sn.apply(null,[this].concat(slice$.call(a))):sn.apply(null,[this,"("].concat(slice$.call(a),[")"]))},e.prototype.mapOp=function(t){var e;switch(!1){case!(e=t.match(/\.([&\|\^]|<<|>>>?)\./)):return e[1];case"of"!==t:return"in";default:return t}},e.prototype.compileChain=function(t){var e,n,i,s;return e=[this.first.compile(t,n=LEVEL_OP+PREC[this.op])],i=this.second.first.cache(t,!0),s=i[0],this.second.first=i[1],e.push(" ",this.op," ",s.compile(t,n)," && ",this.second.compile(t,LEVEL_OP)),t.level<=LEVEL_OP?sn.apply(null,[this].concat(slice$.call(e))):sn.apply(null,[this,"("].concat(slice$.call(e),[")"]))},e.prototype.compileExistence=function(t){var n;return this.void||!t.level?(n=e("&&",Existence(this.first,!0),this.second),(n.void=!0,n).compileNode(t)):(n=this.first.cache(t,!0),sn(this,If(Existence(n[0]),n[1]).addElse(this.second).compileExpression(t)))},e.prototype.compileAnyInstanceOf=function(t,n){var i,s,r,o,a,l,c;for(i=this.first.cache(t),s=i[0],r=i[1],this.temps=i[2],o=e("instanceof",s,n.shift()),a=0,l=n.length;a<l;++a)c=n[a],o=e("||",o,e("instanceof",r,c));return sn(this,Parens(o).compile(t))},e.prototype.compileMinMax=function(t){var n,i,s;return n=this.first.cache(t,!0),i=this.second.cache(t,!0),s=e(this.op.charAt(),n[0],i[0]),sn(this,If(s,n[1]).addElse(i[1]).compileExpression(t))},e.prototype.compileMethod=function(t,e,n,i){var s;return s=[this.second].concat(i||[]),this.first["is"+e]()?sn(this,Chain(this.first,[Index(Key(n)),Call(s)]).compile(t)):(s.unshift(this.first),sn(this,Call.make(JS(util(n)+".call"),s).compile(t)))},e.prototype.compileJoin=function(t){return this.compileMethod(t,"Array","join")},e.prototype.compileRemove=function(t){return this.compileMethod(t,"String","replace",JS("''"))},e.prototype.compileSplit=function(t){return this.compileMethod(t,"String","split")},e.prototype.compileRepeat=function(t){var e,n,i,s,r,o,a,l,c,p,h,u;if(e=this.first,n=this.second,i=(e=e.expandSlice(t).unwrap()).items,s=e.isArray()&&"Array",i&&!snEmpty(r=Splat.compileArray(t,i))&&(e=JS(r),i=null),s&&!i||!(n instanceof Literal&&n.value<32))return sn(this,Call.make(Util("repeat"+(s||"String")),[e,n]).compile(t));if(n=+n.value,1<=n&&n<2)return sn(this,e.compile(t));if(i){if(n<1)return sn(this,Block(i).add(JS("[]")).compile(t));for(o=[],a=0,l=i.length;a<l;++a)c=a,p=i[a],h=p.cache(t,1),i[c]=h[0],o[o.length]=h[1];return i.push((h=JS(),h.compile=function(){return sn.apply(null,[this].concat(slice$.call(repeatArray$([", ",List.compile(t,o)],n-1).slice(1))))},h)),sn(this,e.compile(t))}return e instanceof Literal?sn(this,(u=(e=e.compile(t).toString()).charAt())+repeatString$(e.slice(1,-1)+"",n)+u):n<1?sn(this,Block(e.it).add(JS("''")).compile(t)):(e=(o=e.cache(t,1,LEVEL_OP))[0]+repeatString$(" + "+o[1],n-1),t.level<LEVEL_OP+PREC["+"]?sn(this,e):sn(this,"(",e,")"))},e.prototype.compilePow=function(t){return sn(null,Call.make(CopyL(this,JS("Math.pow")),[this.first,this.second]).compile(t))},e.prototype.compileConcat=function(t){var n;return n=function(t){switch(!1){case!(t instanceof e&&"++"===t.op):return n(t.first).concat(n(t.second));default:return[t]}},sn(null,Chain(this.first).add(CopyL(this,Index(Key("concat"),".",!0))).add(Call(n(this.second))).compile(t))},e.prototype.compileCompose=function(t){var n,i,s;for(n=this.op,i=[this.first],s=this.second;s instanceof e&&s.op===n&&!s.partial;)i.push(s.first),s=s.second;return i.push(s),"<<"===n&&i.reverse(),sn(this,Chain(Var(util("compose"))).add(Call(i)).compile(t))},e.prototype.compileMod=function(t){var e,n;return e=t.scope.temporary(),n=[sn(this,"((("),this.first.compile(t),sn(this,") % ("),sn(this,e," = "),this.second.compile(t),sn(this,") + ",e,") % ",e,")")],t.scope.free(e),sn.apply(null,[null].concat(slice$.call(n)))},e.prototype.compilePartial=function(t){var n,i,s;switch(n=Var("it"),!1){case!(null==this.first&&null==this.second):return i=Var("x$"),s=Var("y$"),sn(this,Fun([i,s],Block(e(this.op,i,s).invertCheck(this)),!1,!0).compile(t));case null==this.first:return sn(this,"(",Fun([n],Block(e(this.op,this.first,n).invertCheck(this)),!0).compile(t),")");default:return sn(this,"(",Fun([n],Block(e(this.op,n,this.second).invertCheck(this)),!0).compile(t),")")}},e.prototype.compileRegexEquals=function(t,e){var n,i,s;return n=e[0],i=e[1],"==="===this.op?(s=this.wasInverted?"test":"exec",sn(this,Chain(n).add(Index(Key(s))).add(Call([i])).compile(t))):sn(this,Unary("!",Chain(n).add(Index(Key("test"))).add(Call([i]))).compile(t))},e.prototype.compileDeepEq=function(t){var e,n,i,s,r,o;for(">=="!==(e=this.op)&&">>="!==e||(e=[this.second,this.first],this.first=e[0],this.second=e[1],this.op=">=="===this.op?"<==":"<<="),"!=="===this.op&&(this.op="===",n=!0),i=0,s=(e=[this.first,this.second]).length;i<s;++i)r=e[i],(r instanceof Obj||r instanceof Arr)&&(r.deepEq=!0);return o=Chain(Var(util("deepEq"))).add(Call([this.first,this.second,Literal("'"+this.op+"'")])),sn(this,(n?Unary("!",o):o).compile(t))},e.prototype.compileXor=function(t){var n,i;return n=Chain(this.first).cacheReference(t),i=Chain(this.second).cacheReference(t),sn(this,e("&&",e("!==",Unary("!",n[0]),Unary("!",i[0])),Parens(e("||",n[1],i[1]))).compile(t))},e}(Node),exports.Assign=Assign=function(t){function e(t,e,i,s,r){var o=this instanceof n?this:new n;return o.left=t,o.op=i||"=",o.logic=s||o.op.logic,o.defParam=r,o.opLoc=o.op,o.op+="",o[e instanceof Node?"right":"unaries"]=e,o}function n(){}var i=extend$((import$(e,t).displayName="Assign",e),t).prototype,s=e;return n.prototype=i,e.prototype.children=["left","right"],e.prototype.show=function(){return[void 0].concat(this.unaries).reverse().join(" ")+[this.logic]+this.op},e.prototype.assigns=function(t){return this.left.assigns(t)},i.delegate(["isCallable","isRegex"],function(t){var e;return("="===(e=this.op)||":="===e)&&this.right&&this.right[t]()}),e.prototype.isArray=function(){switch(this.op){case"=":case":=":return this.right&&this.right.isArray();case"/=":return this.right&&this.right.isMatcher()}},e.prototype.isString=function(){switch(this.op){case"=":case":=":case"+=":case"*=":return this.right&&this.right.isString();case"-=":return this.right&&this.right.isMatcher()}},e.prototype.unfoldSoak=function(t){var n,i,s,r,o;return this.left instanceof Existence?(s=(i=this.left=this.left.it).name,delete i.name,(n=s)?(r=this.right,r=e(this.right=Var(n),r)):(i=this.right.cache(t),r=i[0],this.right=i[1],o=i[2]),i=If(Existence(r),this),i.temps=o,i.cond=this.cond,i.void=this.void,i):If.unfoldSoak(t,this,"left")},e.prototype.unfoldAssign=function(){return this.access&&this},e.prototype.compileNode=function(t){var e,n,i,s,r,o,a,l,c,p,h,u,f,d,m,y,g;if(this.left instanceof Slice&&"="===this.op)return this.compileSplice(t);if(e=this.left,(n=this.left instanceof Splat)&&(e=e.it),e=e.expandSlice(t,!0).unwrap(),n)return e instanceof List||this.left.carp("invalid splat"),this.compileSpread(t,e);if(!this.right)for(e.isAssignable()||e.carp("invalid unary assign"),i=Chain(e).cacheReference(t),e=i[0],this.right=i[1],s=0,r=(i=this.unaries).length;s<r;++s)o=i[s],this.right=Unary(o,this.right);return e.isEmpty()?sn(null,(i=Parens(this.right),i.front=this.front,i.newed=this.newed,i).compile(t)):(e.getDefault()&&(this.right=Binary(e.op,this.right,e.second),e=e.first),e.items?this.compileDestructuring(t,e):(e.isAssignable()||e.carp("invalid assign"),this.logic?this.compileConditional(t,e):(o=this.op,a=this.right,"<?="===o||">?="===o?this.compileMinMax(t,e,a):(("**="===o||"^="===o||"%%="===o||"++="===o||"|>="===o||"*="===o&&a.isString()||("-="===o||"/="===o)&&a.isMatcher())&&(i=Chain(e).cacheReference(t),e=i[0],l=i[1],a=Binary(o.slice(0,-1),l,a),o=":="),".&.="!==o&&".|.="!==o&&".^.="!==o&&".<<.="!==o&&".>>.="!==o&&".>>>.="!==o||(o=o.slice(1,-2)+"="),(a=a.unparen()).ripName(e=e.unwrap()),c=sn(this.opLoc," ",o.replace(":","")," "),p=(e.front=!0,e).compile(t,LEVEL_LIST),(h=e instanceof Var)&&("="===o?t.scope.declare(p.toString(),e,this.const||!this.defParam&&t.const&&"$"!==p.toString().slice(-1)):(u=t.scope.checkReadOnly(p.toString()))&&e.carp("assignment to "+u+' "'+p+'"',ReferenceError)),e instanceof Chain&&a instanceof Fun&&(f=p.toString().split(".prototype."),d=p.toString().split("."),f.length>1?a.inClass=f[0]:d.length>1&&(a.inClassStatic=slice$.call(d,0,-1).join(""))),m=!t.level&&a instanceof While&&!a.else&&(h||e instanceof Chain&&e.isSimpleAccess())?(y=a.objComp?"{}":"[]",[g=t.scope.temporary("res")," = "+y+";\n"+this.tab,a.makeReturn(g).compile(t),"\n"+this.tab,p,c,t.scope.free(g)]):[p,c,a.compile(t,LEVEL_LIST)],t.level>LEVEL_LIST&&(m=["("].concat(slice$.call(m),[")"])),sn.apply(null,[null].concat(slice$.call(m)))))))},e.prototype.compileConditional=function(t,e){var n,i;return e instanceof Var&&in$(this.logic,["?"])&&"="===this.op&&t.scope.declare(e.value,e),n=Chain(e).cacheReference(t),t.level+=LEVEL_OP<t.level,i=Binary(this.logic,n[0],(this.logic=!1,this.left=n[1],this)),sn(this,(i.void=this.void,i).compileNode(t))},e.prototype.compileMinMax=function(t,n,i){var s,r,o,a,l;return s=Chain(n).cacheReference(t),r=i.cache(t,!0),o=Binary(this.op.replace("?",""),s[0],r[0]),a=e(s[1],r[1],":="),this.void||!t.level?Parens(Binary("||",o,a)).compile(t):(l=o.first.cache(t,!0),o.first=l[0],n=l[1],sn(this,If(o,n).addElse(a).compileExpression(t)))},e.prototype.compileDestructuring=function(t,e){var n,i,s,r,o,a,l,c,p,h,u,f,d,m;for(n=e.items,i=n.length,s=t.level&&!this.void,r=this.right.compile(t,1===i?LEVEL_CALL:LEVEL_LIST),(o=e.name)?(a=sn(this,o," = ",r),t.scope.declare(r=o,e)):!(s||i>1)||ID.test(r.toString())&&!e.assigns(r.toString())||(a=sn(this,l=t.scope.temporary()," = ",r),r=l),"arguments"!==r.toString()||s||(c=!0,e instanceof Arr||this.carp("arguments can only destructure to array")),p=this["rend"+e.constructor.displayName](t,n,r,c),l&&t.scope.free(l),a&&p.unshift(a),!s&&p.length||p.push(r),h=[],u=c?"; ":", ",f=0,d=p.length;f<d;++f)m=p[f],h.push(m,u);return h.pop(),p.length<2||t.level<LEVEL_LIST?sn.apply(null,[this].concat(slice$.call(h))):sn.apply(null,[this,"("].concat(slice$.call(h),[")"]))},e.prototype.compileSplice=function(t){var e,n,i,s,r,o;return e=Chain(this.left.from).cacheReference(t),n=e[0],i=e[1],e=Chain(this.right).cacheReference(t),s=e[0],r=e[1],o=Binary("-",this.left.to,i),sn(this,Block([Chain(Var(util("splice"))).add(Index(Key("apply"),".",!0)).add(Call([this.left.target,Chain(Arr([n,o])).add(Index(Key("concat"),".",!0)).add(Call([s]))])),r]).compile(t,LEVEL_LIST))},e.prototype.compileSpread=function(t,e){var n,i,r,o,a=this;return i=(n=this.unaries)?[n,n]:e.items.length<=1?[i=this.right,i]:this.right.cache(t,!0),r=i[0],o=i[1],this.compileSpreadOver(t,e,function(t){var e;return e=s(t,r,a.op,a.logic),r=o,e})},e.prototype.rendArr=function(t,n,i,s){function r(t,e){return new For({ref:!0,from:t,op:"til",to:e}).makeComprehension(Chain(Var("arguments")).add(Index(Literal(".."))),[])}function o(){switch(!1){case!u:return Arr.wrap(JS(p+" < ("+m+" = "+d+") ? "+p+" : ("+m+" = "+p+")"));case!s:return r(JS(p+" < ("+m+" = "+d+") ? "+p+" : ("+m+" = "+p+")"),Var(m));default:return Arr.wrap(JS(p+" < ("+m+" = "+d+") ? "+util("slice")+".call("+i+", "+p+", "+m+") : ("+m+" = "+p+", [])"))}}var a,l,c,p,h,u,f,d,m,y,g,v,b,L,E;for(a=[],l=0,c=n.length;l<c;++l)if(p=l,h=n[l],!h.isEmpty()){if(h instanceof Splat)if(f&&h.carp("multiple splat in an assignment"),u=(h=h.it).isEmpty(),p+1===(f=n.length)){if(u)break;d=s?r(Literal(p),Chain(Var("arguments")).add(Index(Key("length")))):Arr.wrap(JS(util("slice")+".call("+i+(p?", "+p+")":")")))}else{if(d=m=i+".length - "+(f-p-1),u&&p+2===f)continue;y=p+1,(this.temps||(this.temps=[])).push(m=t.scope.temporary("i")),d=o()}else(g=m)&&y<p&&(g+=" + "+(p-y)),d=Chain(v||(v=Literal(i)),[Index(JS(g||p))]);h instanceof e&&(h=Binary(h.op,h.left,h.right,h.logic||!0)),s?!(h instanceof Var)&&d instanceof For?((this.temps||(this.temps=[])).push(b=t.scope.temporary("ref")),L=Var(b),a.push((E=clone$(this),E.left=L,E.right=d,E.void=!0,E).compile(t,LEVEL_TOP)),a.push((E=clone$(this),E.left=h,E.right=L,E.void=!0,E).compile(t,LEVEL_TOP))):a.push((E=clone$(this),E.left=h,E.right=d,E.void=!0,E).compile(t,LEVEL_TOP)):a.push((E=clone$(this),E.left=h,E.right=d,E.void=!0,E).compile(t,LEVEL_PAREN))}return a},e.prototype.rendObj=function(t,e,n){var i,s,r,o,a,l,c,p,h,u=[];for(i=0,s=e.length;i<s;++i)r=e[i],(o=r instanceof Splat)&&(r=r.it),(a=r.getDefault())&&(r=r.first),r instanceof Parens?(l=Chain(r.it).cacheReference(t),r=l[0],c=l[1]):r instanceof Prop?r=(c=r.key,r).val:c=r,r instanceof Key&&(r=CopyL(r,Var(r.name))),a&&(a.first=r,r=a),p=Chain(h||(h=Var(n)),[Index(c.maybeKey())]),o&&(p=Import(Obj(),p)),u.push((l=clone$(this),l.left=r,l.right=p,l.void=!0,l).compile(t,LEVEL_PAREN));return u},e}(Node),exports.Import=Import=function(t){function e(t,e,i){var s=this instanceof n?this:new n;return s.left=t,s.right=e,s.all=i&&"All",!i&&t instanceof Obj&&e.items?Obj(t.items.concat(e.asObj().items)):s}function n(){}var i=extend$((import$(e,t).displayName="Import",e),t).prototype;return n.prototype=i,e.prototype.children=["left","right"],e.prototype.show=function(){return this.all},i.delegate(["isCallable","isArray"],function(t){return this.left[t]()}),e.prototype.unfoldSoak=function(t){var e,n,i,s;return e=this.left,e instanceof Existence&&!e.negated?((e=e.it)instanceof Var?(n=(this.left=e).value,t.scope.check(n,!0)||(e=JS("typeof "+n+" != 'undefined' && "+n))):(i=e.cache(t),e=i[0],this.left=i[1],s=i[2]),i=If(e,this),i.temps=s,i.soak=!0,i.cond=this.cond,i.void=this.void,i):If.unfoldSoak(t,this,"left")||(this.void||!t.level)&&If.unfoldSoak(t,this,"right")},e.prototype.compileNode=function(t){var e;return e=this.right,!this.all&&(e instanceof Chain&&(e=e.unfoldSoak(t)||e.unfoldAssign(t)||e.expandSlice(t).unwrap()),e instanceof List)?this.compileAssign(t,e.asObj().items):CopyL(this,Call.make(Util("import"+(this.all||"")),[this.left,e])).compileNode(t)},e.prototype.compileAssign=function(t,n){var i,s,r,o,a,l,c,p,h,u,f,d,m,y,g,v;if(!n.length)return this.left.compile(t);for(i=!t.level,this.proto||n.length<2&&(i||this.void||n[0]instanceof Splat)?(s=this.left,s.isComplex()&&(s=Parens(s))):(r=this.left.cache(t),o=r[0],s=r[1],this.temps=r[2]),r=i?[";","\n"+this.tab]:[","," "],a=r[0],l=r[1],a+=l,c=this.temps?[o.compile(t,LEVEL_PAREN),a]:[],p=0,h=n.length;p<h;++p)if(u=p,f=n[p],u&&c.push(d?l:a),d=f.comment)c.push(f.compile(t));else if(f instanceof Splat)c.push(e(s,f.it).compile(t));else{if((m=f.getDefault())&&(f=f.first),y=f instanceof Parens)r=f.it.cache(t,!0),g=r[0],v=r[1];else if(f instanceof Prop){if(g=f.key,v=f.val,f.accessor){g instanceof Key&&(g=JS("'"+g.name+"'")),c.push("Object.defineProperty(",s.compile(t,LEVEL_LIST),", ",g.compile(t,LEVEL_LIST),", ",f.compileDescriptor(t),")");continue}}else g=v=f;y||(g=g.maybeKey()),m&&(m.first=v,v=m),c.push(Assign(Chain(s,[Index(g)]),v).compile(t,LEVEL_PAREN))}return i?sn.apply(null,[null].concat(slice$.call(c))):(this.void||f instanceof Splat||c.push(d?" ":", ",s.compile(t,LEVEL_PAREN)),t.level<LEVEL_LIST?sn.apply(null,[null].concat(slice$.call(c))):sn.apply(null,[null,"("].concat(slice$.call(c),[")"])))},e}(Node),exports.In=In=function(t){function e(t,e){this.item=t,this.array=e}var n=extend$((import$(e,t).displayName="In",e),t).prototype;return importAll$(n,arguments[1]),e.prototype.children=["item","array"],e.prototype.compileNode=function(t){var n,i,s,r,o,a,l,c,p,h,u,f;if(i=(n=this.array.expandSlice(t).unwrap()).items,!(n instanceof Arr)||i.length<2)return sn(this,this.negated?"!":"",util("in"),"(",this.item.compile(t,LEVEL_LIST),", ",n.compile(t,LEVEL_LIST),")");for(s=[],r=this.item.cache(t,!1,LEVEL_PAREN),o=r[0],a=r[1],r=this.negated?[" !== "," && "]:[" === "," || "],l=r[0],c=r[1],p=0,h=i.length;p<h;++p)u=p,f=i[p],s.length>0&&s.push(c),f instanceof Splat?(s.push((r=new e(Var(a),f.it),r.negated=this.negated,r).compile(t,LEVEL_TOP)),u||o===a||(s=["("+o+", "].concat(slice$.call(s),[")"]))):s.push(u||o===a?a:"("+o+")",l,f.compile(t,LEVEL_OP+PREC["=="]));return o===a||t.scope.free(a),t.level<LEVEL_OP+PREC["||"]?sn.apply(null,[this].concat(slice$.call(s))):sn.apply(null,[this,"("].concat(slice$.call(s),[")"]))},e}(Node,Negatable),exports.Existence=Existence=function(t){function e(t,e){var i=this instanceof n?this:new n;return i.it=t,i.negated=e,i}function n(){}var i=extend$((import$(e,t).displayName="Existence",e),t).prototype;return importAll$(i,arguments[1]),n.prototype=i,e.prototype.children=["it"],e.prototype.compileNode=function(t){var e,n,i,s,r;return n=this.it.unwrap(),n.front=this.front,e=n,i=[e.compile(t,LEVEL_OP+PREC["=="])],e instanceof Var&&!t.scope.check(i.join(""),!0)?(n=this.negated?["||","="]:["&&","!"],s=n[0],r=n[1],i=["typeof "].concat(slice$.call(i),[" "+r+"= 'undefined' "+s+" "],slice$.call(i),[" "+r+"== null"])):i.push(" "+(s=this.negated?"==":"!=")+" null"),t.level<LEVEL_OP+PREC[s]?sn.apply(null,[this].concat(slice$.call(i))):sn(this,"(",i,")")},e}(Node,Negatable),exports.Fun=Fun=function(t){function e(t,e,i,s,r,o){var a=this instanceof n?this:new n;return a.params=t||[],a.body=e||Block(),a.bound=i&&"this$",a.curried=s||!1,a.hushed=null!=r&&r,a.generator=null!=o&&o,a}function n(){}var i=extend$((import$(e,t).displayName="Fun",e),t).prototype;return n.prototype=i,e.prototype.children=["params","body"],e.prototype.show=function(){var t;return[this.name]+[(t=this.bound)?"~"+t:void 0]},e.prototype.named=function(t){return this.name=t,this.statement=!0,this},e.prototype.isCallable=YES,e.prototype.isStatement=function(){return!!this.statement},e.prototype.traverseChildren=function(e,n){if(n)return t.prototype.traverseChildren.apply(this,arguments)},e.prototype.makeReturn=function(){return this.statement?(this.returns=!0,this):t.prototype.makeReturn.apply(this,arguments)},e.prototype.ripName=function(t){this.name||(this.name=t.varName())},e.prototype.compileNode=function(t){var e,n,i,s,r,o,a,l,c,p,h,u,f=this;return e=t.scope,n=e.shared||e,i=t.scope=this.body.scope=new Scope(this.wrapper?e:n,this.wrapper&&n),i.fun=this,(s=this.proto)&&i.assign("prototype",s.compile(t)+".prototype"),(s=this.cname)&&i.assign("constructor",s),o=t.loop,delete t.loop,(r=o)&&(t.indent=this.tab=""),t.indent+=TAB,a=this.body,l=this.name,c=this.tab,p=["function"],this.generator?(this.ctor&&this.carp("a constructor can't be a generator"),t.inGenerator=!0,p.push("*")):this.wrapper||(t.inGenerator=!1),"this$"===this.bound&&(this.ctor?(i.assign("this$","this instanceof ctor$ ? this : new ctor$"),a.lines.push(Return(Literal("this$")))):(s=null!=(o=n.fun)?o.bound:void 0)?this.bound=s:n.assign("this$","this")),this.statement&&(l||this.carp("nameless function declaration"),e===t.block.scope||this.carp("misplaced function declaration"),this.accessor&&this.carp("named accessor"),e.add(l,"function",this)),(this.statement||l&&this.labeled)&&p.push(" ",i.add(l,"function",this)),this.hushed||this.ctor||this.newed||a.makeReturn(),p.push("(",this.compileParams(t,i),")"),p=[sn.apply(null,[this].concat(slice$.call(p)))],p.push("{"),snEmpty(h=a.compileWithDeclarations(t))||p.push("\n",h,"\n"+c),p.push("}"),u=function(){return f.curried&&f.hasSplats&&f.carp("cannot curry a function with a variable number of arguments"),f.curried&&f.params.length>1&&!f.classBound?f.bound?[util("curry"),"(("].concat(slice$.call(p),["), true)"]):[util("curry"),"("].concat(slice$.call(p),[")"]):p},r?e.assign(e.temporary("fn"),sn.apply(null,[null].concat(slice$.call(u())))):(this.returns?p.push("\n"+c+"return ",l,";"):this.bound&&this.ctor&&p.push(" function ctor$(){} ctor$.prototype = prototype;"),p=u(),this.front&&!this.statement?sn.apply(null,[null,"("].concat(slice$.call(p),[")"])):sn.apply(null,[null].concat(slice$.call(p))))},e.prototype.compileParams=function(t,e){function n(){switch(!1){case!y:return Binary(a.op,b,a.second);case!v:return fold(function(t,e){return e.it=t,e},b,g.reverse());default:return b}}var i,s,r,o,a,l,c,p,h,u,f,d,m,y,g,v,b,L,E;for(i=this.params,s=i.length,r=this.body,o=i.length-1;o>=0&&(a=i[o],a.isEmpty()||a.filler);--o)--i.length;for(o=0,l=i.length;o<l;++o)c=o,a=i[o],a.left instanceof Splat&&a.carp("invalid splat"),a instanceof Splat?(this.hasSplats=!0,p=c):"="===a.op&&(i[c]=Binary(a.logic||"?",a.left,a.right));for(null!=p?h=i.splice(p,9e9):this.accessor?(u=i[1])&&u.carp("excess accessor parameter"):s||this.wrapper||r.traverseChildren(function(t){return"it"===t.value||null})&&(i[0]=Var("it")),f=[],d=[],o=0,l=i.length;o<l;++o){if(a=i[o],m=a,(y=m.getDefault())&&(m=m.first),m.isEmpty())m=Var(e.temporary("arg"));else if(".."===m.value)m=Var(t.ref=e.temporary());else if(m instanceof Var)y&&d.push(Assign(m,a.second,"=",a.op,!0));else{for(g=[];m instanceof Unary;)v=!0,g.push(m),m=m.it;b=Var((E=(L=m.it||m).name,delete L.name,E||m.varName()||e.temporary("arg"))),d.push(Assign(m,n())),m=b}f.push(e.add(m.value,"arg",a),", ")}if(h){for(;p--;)h.unshift(Arr());d.push(Assign(Arr(h),Literal("arguments")))}return d.length&&(L=this.body).prepend.apply(L,d),f.pop(),sn.apply(null,[null].concat(slice$.call(f)))},e}(Node),exports.Class=Class=function(t){function e(t){var e;this.title=t.title,this.sup=t.sup,this.mixins=t.mixins,e=t.body,this.fun=Fun([],e)}return extend$((import$(e,t).displayName="Class",e),t).prototype,e.prototype.children=["title","sup","mixins","fun"],e.prototype.isCallable=YES,e.prototype.ripName=function(t){this.name=t.varName()},e.prototype.compile=function(t,e){function n(t){var e,n,i,s,r;if(t instanceof Block)for(e=0,i=(n=t.lines).length;e<i;++e)s=e,r=n[e],r instanceof Obj&&(t.lines[s]=y(r,b))}var i,s,r,o,a,l,c,p,h,u,f,d,m,y,g,v,b,L,E,S,C,x,k,$,A;for(i=this.fun,s=i.body,r=s.lines,o=this.title,CopyL(this,i),a=[],l=[],c=null!=o?o.varName():void 0,p=c||this.name,ID.test(p||"")?i.cname=p:p="constructor",h=Var("prototype"),u=i.proto=Var(i.bound=p),f="constructor$$",y=function(e,n){var i,s,r,o,c,p,h;for(i=0;i<e.items.length;i++)if(s=e.items[i],r=s.key,(r instanceof Key&&r.name===f||r instanceof Literal&&r.value==="'"+f+"'")&&(d&&e.carp("redundant constructor"),d=s.val,e.items.splice(i--,1),m=n),s.val instanceof Fun||s.accessor)for(r.isComplex()&&(r=Var(t.scope.temporary("key")),s.key=Assign(r,s.key)),s.val.bound&&(s.val.curried?l.push(s.key):a.push(s.key),s.val.bound=!1,s.val.classBound=!0),o=0,p=(c=[].concat(s.val)).length;o<p;++o)h=c[o],h.meth=r;return e.items.length?(c=Import(Chain(u).add(Index(Key("prototype"))),e),c.proto=!0,c):Literal("void")},g=0,v=r.length;g<v;++g)b=g,L=r[g],L instanceof Obj?r[b]=y(L,b):L instanceof Fun&&!L.statement?(d&&L.carp("redundant constructor"),d=L):L instanceof Assign&&L.left instanceof Chain&&"this"===L.left.head.value&&L.right instanceof Fun?L.right.stat=L.left.tails[0].key:L.traverseChildren(n);for(d||(d=r[r.length]=this.sup?Fun([],Block(Chain(new Super).add(Call([Splat(Literal("arguments"))])))):Fun()),d instanceof Fun||(r.splice(m+1,0,Assign(Var(f),d)),r.unshift(d=Fun([],Block(Return(Chain(Var(f)).add(Call([Splat("arguments",!0)]))))))),d.name=p,d.ctor=!0,d.statement=!0,g=0,v=a.length;g<v;++g)E=a[g],d.body.lines.unshift(Assign(Chain(Literal("this")).add(Index(E)),Chain(Var(util("bind"))).add(Call([Literal("this"),Literal("'"+E.name+"'"),Var("prototype")]))));for(g=0,v=l.length;g<v;++g)E=l[g],d.body.lines.unshift(Assign(Chain(Literal("this")).add(Index(Key("_"+E.name))),Chain(Var(util("curry"))).add(Call([Chain(Var("prototype")).add(Index(E)),Var("true")]))),Assign(Chain(Literal("this")).add(Index(E)),Chain(Var(util("bind"))).add(Call([Literal("this"),Literal("'_"+E.name+"'")]))));if(r.push(u),S=[],(C=this.sup)&&(S.push(C),x=Chain(Import(Literal("this"),Var("superclass"))),i.proto=Util.Extends(i.cname?Block([Assign(x.add(Index(Key("displayName"))),Literal("'"+p+"'")),Literal(p)]):x,(k=i.params)[k.length]=Var("superclass"))),C=this.mixins){for($=[],g=0,v=C.length;g<v;++g)S[S.length]=C[g],
$.push(Import(h,JS("arguments["+(S.length-1)+"]"),!0));x=$,s.prepend.apply(s,x)}return i.cname&&!this.sup&&s.prepend(Literal(p+".displayName = '"+p+"'")),A=Parens(Call.make(i,S),!0),c&&o.isComplex()&&(A=Assign(u,A)),o&&(A=Assign(o,A)),sn(null,A.compile(t,e))},e}(Node),exports.Super=Super=function(t){function e(){}return extend$((import$(e,t).displayName="Super",e),t).prototype,e.prototype.isCallable=YES,e.prototype.compile=function(t){var e,n,i,s;if(e=t.scope,!this.sproto){for(;n=!e.get("superclass")&&e.fun;e=e.parent){if(i=n,n=i.meth)return sn(this,"superclass.prototype",Index(n).compile(t));if(n=i.stat)return sn(this,"superclass",Index(n).compile(t));if(n=e.fun.inClass)return sn(this,n,".superclass.prototype.",e.fun.name);if(n=e.fun.inClassStatic)return sn(this,n,".superclass.",e.fun.name)}if(n=null!=(s=t.scope.fun)?s.name:void 0)return sn(this,n,".superclass")}return sn(this,"superclass")},e}(Node),exports.Parens=Parens=function(t){function e(t,e,i,s,r){var o=this instanceof n?this:new n;return o.it=t,o.keep=e,o.string=i,o.lb=s,o.rb=r,o}function n(){}var i=extend$((import$(e,t).displayName="Parens",e),t).prototype;return n.prototype=i,e.prototype.children=["it"],e.prototype.show=function(){return this.string&&'""'},i.delegate(["isComplex","isCallable","isArray","isRegex"],function(t){return this.it[t]()}),e.prototype.isString=function(){return this.string||this.it.isString()},e.prototype.unparen=function(){return this.keep?this:this.it.unparen()},e.prototype.compile=function(t,e){var n;return null==e&&(e=t.level),n=this.it,n.cond||(n.cond=this.cond),n.void||(n.void=this.void),!this.calling||e&&!this.void||(n.head.hushed=!0),this.keep||this.newed||e>=LEVEL_OP+PREC[n.op]?n.isStatement()?n.compileClosure(t):sn(null,sn(this.lb,"("),n.compile(t,LEVEL_PAREN),sn(this.rb,")")):(n.front=this.front,n).compile(t,e||LEVEL_PAREN)},e}(Node),exports.Splat=Splat=function(t){function e(t,e){var i=this instanceof n?this:new n;return i.it=t,i.filler=e,i}function n(){}function i(t){var n,s,r;for(n=-1;s=t[++n];)s instanceof e&&(r=s.it,r.isEmpty()?t.splice(n--,1):r instanceof Arr&&(t.splice.apply(t,[n,1].concat(slice$.call(i(r.items)))),n+=r.items.length-1));return t}function s(t){return t.isArray()?t:Call.make(JS(util("slice")+".call"),[t])}var r,o=extend$((import$(e,t).displayName="Splat",e),t).prototype;return n.prototype=o,r=Parens.prototype,o.children=r.children,o.isComplex=r.isComplex,e.prototype.isAssignable=YES,e.prototype.assigns=function(t){return this.it.assigns(t)},e.prototype.compile=function(){return this.carp("invalid splat")},e.compileArray=function(t,n,r){var o,a,l,c,p,h,u;for(i(n),o=0,a=0,l=n.length;a<l&&(c=n[a],!(c instanceof e));++a)++o;if(o>=n.length)return sn(this,"");if(!n[1])return sn(this,(r?Object:s)(n[0].it).compile(t,LEVEL_LIST));for(p=[],h=[],a=0,l=(u=n.splice(o,9e9)).length;a<l;++a)c=u[a],c instanceof e?(h.length&&p.push(Arr(h.splice(0,9e9))),p.push(s(c.it))):h.push(c);return h.length&&p.push(Arr(h)),sn(null,(o?Arr(n):p.shift()).compile(t,LEVEL_CALL),sn(this,".concat("),List.compile(t,p),sn(this,")"))},e}(Node),exports.Jump=Jump=function(t){function e(t,e){this.verb=t,this.label=e}return extend$((import$(e,t).displayName="Jump",e),t).prototype,e.prototype.show=function(){var t;return(this.verb||"")+((t=this.label)?" "+t:"")},e.prototype.isStatement=YES,e.prototype.makeReturn=THIS,e.prototype.getJump=function(t){var e,n;return t||(t={}),t[this.verb]?(e=this.label)?!in$(e,null!=(n=t.labels)?n:t.labels=[])&&this:void 0:this},e.prototype.compileNode=function(t){var e,n;return(e=this.label)?in$(e,null!=(n=t.labels)?n:t.labels=[])||this.carp('unknown label "'+e+'"'):t[this.verb]||this.carp("stray "+this.verb),sn(this,this.show()+";")},e.extended=function(t){t.prototype.children=["it"],this[t.displayName.toLowerCase()]=t},e}(Node),exports.Throw=Throw=function(t){function e(t){var e=this instanceof n?this:new n;return e.it=t,e}function n(){}var i=extend$((import$(e,t).displayName="Throw",e),t).prototype;return n.prototype=i,e.prototype.getJump=VOID,e.prototype.compileNode=function(t){var e;return sn(this,"throw ",(null!=(e=this.it)?e.compile(t,LEVEL_PAREN):void 0)||"null",";")},e}(Jump),exports.Return=Return=function(t){function e(t){var e=this instanceof n?this:new n;return t&&"void"!==t.value&&(e.it=t),e}function n(){}var i=extend$((import$(e,t).displayName="Return",e),t).prototype;return n.prototype=i,e.prototype.getJump=THIS,e.prototype.compileNode=function(t){var e;return sn.apply(null,[this,"return"].concat((e=this.it)?[" ",e.compile(t,LEVEL_PAREN)]:[],[";"]))},e}(Jump),exports.While=While=function(t){function e(t,e,n){this.un=e,n&&(n instanceof Node?this.update=n:this.post=!0),(this.post||t.value!==""+!e)&&(this.test=t)}var n=extend$((import$(e,t).displayName="While",e),t).prototype;return e.prototype.children=["test","body","update","else"],e.prototype.aSource="test",e.prototype.aTargets=["body","update"],e.prototype.show=function(){return[this.un?"!":void 0,this.post?"do":void 0].join("")},n.isStatement=n.isArray=YES,e.prototype.makeComprehension=function(t,e){for(this.isComprehension=!0;e.length;)t=e.pop().addBody(Block(t)),t.isComprehension||(t.inComprehension=!0);return this.addBody(Block(t))},e.prototype.getJump=function(t){var e,n,i,s,r;for(t||(t={}),t.continue=!0,t.break=!0,e=0,s=(n=(null!=(i=this.body)?i.lines:void 0)||[]).length;e<s;++e)if(r=n[e],r.getJump(t))return r},e.prototype.addBody=function(t){var e;return this.body=t,this.guard&&(this.body=Block(If(this.guard,this.body))),e=this.body.lines[0],"continue"!==(null!=e?e.verb:void 0)||e.label||(this.body.lines.length=0),this},e.prototype.addGuard=function(t){return this.guard=t,this},e.prototype.addObjComp=function(t){return this.objComp=null==t||t,this},e.prototype.makeReturn=function(t){var e,n,i,s;return this.hasReturned?this:(t?this.objComp?this.body=Block(this.body.makeReturn(t,!0)):(this.body||this.index||this.addBody(Block(Var(this.index="ridx$"))),e=null!=(n=this.body.lines)?n[n.length-1]:void 0,!this.isComprehension&&!this.inComprehension||null!=e&&e.isComprehension?(this.resVar=t,null!=(s=this.else)&&s.makeReturn.apply(s,arguments)):((i=this.body).makeReturn.apply(i,arguments),null!=(i=this.else)&&i.makeReturn.apply(i,arguments),this.hasReturned=!0)):this.getJump()||(this.returns=!0),this)},e.prototype.compileNode=function(t){var e,n,i,s;return t.loop=!0,this.test&&(this.un?this.test=this.test.invert():this.anaphorize()),this.post?sn(null,sn(this,"do {"),this.compileBody((t.indent+=TAB,t))):(e=(null!=(n=this.test)?n.compile(t,LEVEL_PAREN):void 0)||"",this.update||this.else?(i=[sn(this,"for (")],this.else&&i.push(this.yet=t.scope.temporary("yet")," = true"),i.push(sn(this,";"),e.toString()&&" ",e,sn(this,";")),(s=this.update)&&i.push(" ",s.compile(t,LEVEL_PAREN))):i=snEmpty(e)?[sn(this,"for (;;")]:[sn(this,"while ("),e],sn.apply(null,[null].concat(slice$.call(i),[sn(this,") {"),this.compileBody((t.indent+=TAB,t))])))},e.prototype.compileBody=function(t){var n,i,s,r,o,a,l,c,p,h,u,f,d,m,y,g,v=this;return t.break=t.continue=!0,n=this.body.lines,i=this.yet,s=this.tab,r=[],o=[],a=[],l=this.objComp?"{}":"[]",p=function(){return null!=c?c:c=t.scope.temporary(v.objComp?"resultObj":"results")},h=null!=n?n[n.length-1]:void 0,(!this.isComprehension&&!this.inComprehension||null!=h&&h.isComprehension)&&(u=!1,null!=h&&h.traverseChildren(function(t){var n;t instanceof Block&&(n=t.lines)[n.length-1]instanceof e&&(u=!0)}),this.returns&&!this.resVar&&(this.resVar=f=t.scope.assign(p(),l)),this.resVar&&(h instanceof e||u)?(d=t.scope.temporary("lresult"),n.unshift(Assign(Var(d),n[n.length-1].objComp?Obj():Arr(),"=")),null!=n[m=n.length-1]&&(n[m]=n[m].makeReturn(d)),a.push(TAB,Chain(Var(this.resVar)).add(Index(Key("push"),".",!0)).add(Call([Chain(Var(d))])).compile(t),";\n"+this.tab)):(this.hasReturned=!0,this.resVar&&this.body.makeReturn(this.resVar))),this.returns&&((!h instanceof e&&!this.hasReturned||this.isComprehension||this.inComprehension)&&null!=n[m=n.length-1]&&(n[m]=n[m].makeReturn(f=t.scope.assign(p(),l),this.objComp)),o.push("\n"+this.tab+"return ",f||l,";"),null!=(y=this.else)&&y.makeReturn()),i&&n.unshift(JS(i+" = false;")),snEmpty(g=this.body.compile(t,LEVEL_TOP))||r.push("\n",g,"\n"+s),r.push.apply(r,a),r.push("}"),this.post&&r.push(sn(this," while ("),this.test.compile((t.tab=s,t),LEVEL_PAREN),sn(this,");")),i&&(r.push(sn(this," if ("),i,sn(this,") "),this.compileBlock(t,Block(this.else))),t.scope.free(i)),sn.apply(null,[null].concat(slice$.call(r),slice$.call(o)))},e}(Node),exports.For=For=function(t){function e(t){var e,n,i,s;for(importAll$(this,t),this.item instanceof Var&&!this.item.value&&(this.item=null),e=0,s=(i=this.kind||[]).length;e<s;++e)n=i[e],this[n]=!0;this.own&&!this.object&&this.carp("`for own` requires `of`")}return extend$((import$(e,t).displayName="For",e),t).prototype,e.prototype.children=["item","source","from","to","step","body"],e.prototype.aSource=null,e.prototype.show=function(){return(this.kind||[]).concat(this.index).join(" ")},e.prototype.addBody=function(e){var n,i,s,r,o=this;return n=!!e.traverseChildren(function(t){if(t instanceof Yield)return!0}),this.let&&(i=this.ref,delete this.ref,i&&(this.item=Literal("..")),e=Block(Call.let((s=[],(r=this.index)&&s.push(Assign(Var(r),Literal("index$$"))),(r=this.item)&&s.push(Assign(r,Literal("item$$"))),s),e,n))),t.prototype.addBody.call(this,e),this.guard&&this.let&&(this.index||this.item)&&this.body.lines[0].if.traverseChildren(function(t){t instanceof Var&&(o.index&&t.value===o.index&&(t.value="index$$"),o.item&&t.value===o.item.value&&(t.value="item$$"))}),this.let&&(n&&(this.body=Block(Yield("yieldfrom",e))),delete this.index,delete this.item),this},e.prototype.compileNode=function(t){var e,n,i,s,r,o,a,l,c,p,h,u,f,d,m,y,g;return t.loop=!0,e=this.temps=[],this.object&&this.index?t.scope.declare(n=this.index):e.push(n=t.scope.temporary("i")),this.body||this.addBody(Block(Var(n))),this.object||(i=(this.step||Literal(1)).compileLoopReference(t,"step"),s=i[0],r=i[1],s===r||e.push(s)),this.from?(this.ref&&(this.item=Var(n)),i=this.to.compileLoopReference(t,"to"),o=i[0],a=i[1],l=this.from.compile(t,LEVEL_LIST),c=n+" = "+l,a!==o&&(c+=", "+a,e.push(o)),!this.step&&+l>+o&&(s=r=-1),p="til"===this.op?"":"=",h=+s?n+" "+"<>".charAt(s<0)+p+" "+o:s+" < 0 ? "+n+" >"+p+" "+o+" : "+n+" <"+p+" "+o):(this.ref&&(this.item=Var(t.scope.temporary("x"))),this.item||this.object&&this.own||this.let?(i=this.source.compileLoopReference(t,"ref",!this.object,!0),u=i[0],f=i[1],u===f||e.push(u)):u=f=this.source.compile(t,LEVEL_PAREN),this.object||(0>s&&~~s===+s?(c=n+" = "+f+".length - 1",h=n+" >= 0"):(e.push(d=t.scope.temporary("len")),c=n+" = 0, "+d+" = "+f+".length",h=n+" < "+d))),this.else&&(this.yet=t.scope.temporary("yet")),m=[sn(this,"for (")],this.object&&m.push(n," in "),(y=this.yet)&&m.push(y," = true, "),this.object?m.push(f):(r===s||(c+=", "+r),m.push(c,"; ",h,"; "+(1==Math.abs(s)?(s<0?"--":"++")+n:n+(s<0?" -= "+s.toString().slice(1):" += "+s)))),this.own&&m.push(sn(this,") if ("),t.scope.assign("own$","{}.hasOwnProperty"),".call(",u,", ",n,")"),m.push(sn(this,") {")),this.let&&this.body.traverseChildren(function(t){switch(t.value){case"index$$":t.value=n;break;case"item$$":t.value=u+"["+n+"]"}}),t.indent+=TAB,this.index&&!this.object&&m.push("\n"+t.indent,Assign(Var(this.index),JS(n)).compile(t,LEVEL_TOP),";"),!this.item||this.item.isEmpty()||this.from||m.push("\n"+t.indent,Assign(this.item,JS(u+"["+n+"]")).compile(t,LEVEL_TOP),";"),this.ref&&(t.ref=this.item.value),g=this.compileBody(t),(this.item||this.index&&!this.object)&&"}"===g.toString().charAt(0)&&m.push("\n"+this.tab),sn.apply(null,[null].concat(slice$.call(m),[g]))},e}(While),exports.StepSlice=StepSlice=function(t){function e(){e.superclass.apply(this,arguments)}return extend$((import$(e,t).displayName="StepSlice",e),t).prototype,e.prototype.makeReturn=function(e){return this.makeReturnArg=e,t.prototype.makeReturn.apply(this,arguments)},e.prototype.compileNode=function(e){var n,i,s,r,o;return this.index=e.scope.temporary("x"),n=this.target.unwrap().cache(e),i=n[0],s=n[1],r=n[2],this.guard=Binary("<",Literal(this.index),Chain(s).add(Index(Key("length")))),this.makeComprehension(Chain(s).add(Index(Literal(this.index))),this),null!=this.makeReturnArg&&this.makeReturn(this.makeReturnArg),o=[],r&&o.push(i.compile(e),";\n"+e.indent),o.push(t.prototype.compileNode.apply(this,arguments)),sn.apply(null,[this].concat(slice$.call(o)))},e}(For),exports.Try=Try=function(t){function e(t,e,n,i){var s;this.attempt=t,this.thrown=e,this.recovery=n,this.ensure=i,null!=(s=this.recovery)&&s.lines.unshift(Assign(this.thrown||Var("e"),Var("e$")))}return extend$((import$(e,t).displayName="Try",e),t).prototype,e.prototype.children=["attempt","recovery","ensure"],e.prototype.show=function(){return this.thrown},e.prototype.isStatement=YES,e.prototype.isCallable=function(){var t;return(null!=(t=this.recovery)?t.isCallable():void 0)&&this.attempt.isCallable()},e.prototype.getJump=function(t){var e;return this.attempt.getJump(t)||(null!=(e=this.recovery)?e.getJump(t):void 0)},e.prototype.makeReturn=function(){var t;return this.attempt=(t=this.attempt).makeReturn.apply(t,arguments),null!=this.recovery&&(this.recovery=(t=this.recovery).makeReturn.apply(t,arguments)),this},e.prototype.compileNode=function(t){var e,n;return t.indent+=TAB,e=[sn(this,"try "),this.compileBlock(t,this.attempt)],(n=this.recovery||!this.ensure&&JS(""))&&e.push(sn(n," catch (e$) "),this.compileBlock(t,n)),(n=this.ensure)&&e.push(sn(n," finally "),this.compileBlock(t,n)),sn.apply(null,[null].concat(slice$.call(e)))},e}(Node),exports.Switch=Switch=function(t){function e(t,e,n,i){var s,r;if(this.type=t,this.topic=e,this.cases=n,this.default=i,"match"===t)e&&(this.target=Arr(e)),this.topic=null;else if(e){if(e.length>1)throw"can't have more than one topic in switch statement";this.topic=this.topic[0]}this.cases.length&&1===(s=(r=this.cases)[r.length-1]).tests.length&&s.tests[0]instanceof Var&&"_"===s.tests[0].value&&(this.cases.pop(),this.default=s.body)}return extend$((import$(e,t).displayName="Switch",e),t).prototype,e.prototype.children=["topic","cases","default"],e.prototype.aSource="topic",e.prototype.aTargets=["cases","default"],e.prototype.show=function(){return this.type},e.prototype.isStatement=YES,e.prototype.isCallable=function(){var t,e,n,i;for(t=0,n=(e=this.cases).length;t<n;++t)if(i=e[t],!i.isCallable())return!1;return!this.default||this.default.isCallable()},e.prototype.getJump=function(t){var e,n,i,s,r;for(t||(t={}),t.break=!0,e=0,i=(n=this.cases).length;e<i;++e)if(s=n[e],r=s.body.getJump(t))return r;return null!=(n=this.default)?n.getJump(t):void 0},e.prototype.makeReturn=function(){var t,e,n,i;for(t=0,n=(e=this.cases).length;t<n;++t)i=e[t],i.makeReturn.apply(i,arguments);return null!=(e=this.default)&&e.makeReturn.apply(e,arguments),this},e.prototype.compileNode=function(t){var e,n,i,s,r,o,a,l,c,p,h,u,f;for(e=this.tab,this.target&&(n=Chain(this.target).cacheReference(t),i=n[0],s=n[1]),r="match"===this.type?(o=s?[i]:[],Block(o.concat([Literal("false")])).compile(t,LEVEL_PAREN)):!!this.topic&&this.anaphorize().compile(t,LEVEL_PAREN),a=[sn(this,"switch (",snSafe(r),") {\n")],l=this.default||this.cases.length-1,t.break=!0,c=0,p=(n=this.cases).length;c<p;++c)h=c,u=n[c],a.push(u.compileCase(t,e,h===l,"match"===this.type||!r,this.type,s));return this.default&&(t.indent=e+TAB,(f=this.default.compile(t,LEVEL_TOP))&&a.push(e+"default:\n",f,"\n")),sn.apply(null,[null].concat(slice$.call(a),[e+"}"]))},e}(Node),exports.Case=Case=function(t){function e(t,e){this.tests=t,this.body=e}return extend$((import$(e,t).displayName="Case",e),t).prototype,e.prototype.children=["tests","body"],e.prototype.isCallable=function(){return this.body.isCallable()},e.prototype.makeReturn=function(){var t,e;return"fallthrough"!==(null!=(t=(e=this.body.lines)[e.length-1])?t.value:void 0)&&(e=this.body).makeReturn.apply(e,arguments),this},e.prototype.compileCase=function(t,e,n,i,s,r){var o,a,l,c,p,h,u,f,d,m,y,g,v,b,L,E,S,C;for(o=[],a=0,c=(l=this.tests).length;a<c;++a)if(p=l[a],p=p.expandSlice(t).unwrap(),p instanceof Arr&&"match"!==s)for(h=0,f=(u=p.items).length;h<f;++h)d=u[h],o.push(d);else o.push(p);if(o.length||o.push(Literal("void")),"match"===s)for(a=0,c=o.length;a<c;++a)m=a,p=o[a],y=Chain(r).add(Index(Literal(m),".",!0)),o[m]=Parens(Chain(p).autoCompare(r?[y]:null));if(i){for(g="match"===s?"&&":"||",d=o[0],m=0;v=o[++m];)d=Binary(g,d,v);o=[(this.t=d,this.aSource="t",this.aTargets=["body"],this).anaphorize().invert()]}for(b=[],a=0,c=o.length;a<c;++a)d=o[a],b.push(e,sn(d,"case ",d.compile(t,LEVEL_PAREN),":\n"));return L=this.body.lines,E=L[L.length-1],(S="fallthrough"===(null!=E?E.value:void 0))&&(L[L.length-1]=JS("// fallthrough")),t.indent=e+=TAB,snEmpty(C=this.body.compile(t,LEVEL_TOP))||b.push(C,"\n"),n||S||E instanceof Jump||b.push(e+"break;\n"),sn.apply(null,[null].concat(slice$.call(b)))},e}(Node),exports.If=If=function(t){function e(t,e,i){var s=this instanceof n?this:new n;return s.if=t,s.then=e,s.un=i,s}function n(){}var i=extend$((import$(e,t).displayName="If",e),t).prototype,s=e;return n.prototype=i,e.prototype.children=["if","then","else"],e.prototype.aSource="if",e.prototype.aTargets=["then"],e.prototype.show=function(){return this.un&&"!"},e.prototype.terminator="",i.delegate(["isCallable","isArray","isString","isRegex"],function(t){var e;return(null!=(e=this.else)?e[t]():void 0)&&this.then[t]()}),e.prototype.getJump=function(t){var e;return this.then.getJump(t)||(null!=(e=this.else)?e.getJump(t):void 0)},e.prototype.makeReturn=function(){var t;return this.then=(t=this.then).makeReturn.apply(t,arguments),null!=this.else&&(this.else=(t=this.else).makeReturn.apply(t,arguments)),this},e.prototype.compileNode=function(t){return this.un?this.if=this.if.invert():this.soak||this.anaphorize(),t.level?this.compileExpression(t):this.compileStatement(t)},e.prototype.compileStatement=function(t){var e,n;return e=[sn(this,"if (",this.if.compile(t,LEVEL_PAREN),") ")],t.indent+=TAB,e.push(this.compileBlock(t,Block(this.then))),(n=this.else)?sn.apply(null,[null].concat(slice$.call(e),[sn(n," else "),n instanceof s?n.compile((t.indent=this.tab,t),LEVEL_TOP):this.compileBlock(t,n)])):sn.apply(null,[null].concat(slice$.call(e)))},e.prototype.compileExpression=function(t){var e,n,i,s;return e=this.then,n=this.else||Literal("void"),this.void&&(e.void=n.void=!0),this.else||!this.cond&&!this.void?(i=[sn(this,this.if.compile(t,LEVEL_COND))],s=n.isComplex()?"\n"+(t.indent+=TAB):" ",i.push(s+"",sn(e,"? "),e.compile(t,LEVEL_LIST),s+"",sn(n,": "),n.compile(t,LEVEL_LIST)),t.level<LEVEL_COND?sn.apply(null,[null].concat(slice$.call(i))):sn(null,"(",i,")")):Parens(Binary("&&",this.if,e)).compile(t)},e.unfoldSoak=function(t,e,n){var i;if(i=e[n].unfoldSoak(t))return e[n]=i.then,i.cond=e.cond,i.void=e.void,i.then=Chain(e),i},e}(Node),exports.Label=Label=function(t){function e(t,e){var n;if(this.label=t||"_",this.it=e,n=(e instanceof Fun||e instanceof Class)&&e||e.calling&&e.it.head)return n.name||(n.name=this.label,n.labeled=!0),e}var n,i=extend$((import$(e,t).displayName="Label",e),t).prototype;return n=Parens.prototype,i.children=n.children,i.isCallable=n.isCallable,i.isArray=n.isArray,e.prototype.show=function(){return this.label},e.prototype.isStatement=YES,e.prototype.getJump=function(t){var e;return t||(t={}),(null!=(e=t.labels)?e:t.labels=[]).push(this.label),this.it.getJump((t.break=!0,t))},e.prototype.makeReturn=function(){var t;return this.it=(t=this.it).makeReturn.apply(t,arguments),this},e.prototype.compileNode=function(t){var e,n,i;return e=this.label,n=this.it,i=t.labels=slice$.call(t.labels||[]),in$(e,i)&&this.carp('duplicate label "'+e+'"'),i.push(e),n.isStatement()||(n=Block(n)),sn(null,sn(this,e,": "),n instanceof Block?(t.indent+=TAB,this.compileBlock(t,n)):n.compile(t))},e}(Node),exports.Cascade=Cascade=function(t){function e(t,e,i){var s=this instanceof n?this:new n;return s.input=t,s.output=e,s.prog1=i,s}function n(){}var i=extend$((import$(e,t).displayName="Cascade",e),t).prototype;return n.prototype=i,e.prototype.show=function(){return this.prog1},e.prototype.children=["input","output"],e.prototype.terminator="",i.delegate(["isCallable","isArray","isString","isRegex"],function(t){return this[this.prog1?"input":"output"][t]()}),e.prototype.getJump=function(t){return this.output.getJump(t)},e.prototype.makeReturn=function(t){return this.ret=t,this},e.prototype.compileNode=function(t){var n,i,s,r,o,a,l,c;return n=t.level,i=this.input,s=this.output,r=this.prog1,o=this.ref,r&&("ret"in this||n&&!this.void)&&s.add((a=Literal(".."),a.cascadee=!0,a)),"ret"in this&&(s=s.makeReturn(this.ret)),o?r||(s=Assign(Var(o),s)):o=t.scope.temporary("x"),i instanceof e?i.ref=o:i&&(i=Assign(Var(o),i)),t.level&&(t.level=LEVEL_PAREN),l=[i.compile(t)],c=Block(s).compile((t.ref=new String(o),t)),"cascade"!==r||t.ref.erred||this.carp("unreferred cascadee"),n?(l.push(", ",c),n>LEVEL_PAREN?sn.apply(null,[null,"("].concat(slice$.call(l),[")"])):sn.apply(null,[null].concat(slice$.call(l)))):sn.apply(null,[null].concat(slice$.call(l),[i.terminator,"\n",c]))},e}(Node),exports.JS=JS=function(t){function e(t,e,i){var s=this instanceof n?this:new n;return s.code=t,s.literal=e,s.comment=i,s}function n(){}var i=extend$((import$(e,t).displayName="JS",e),t).prototype;return n.prototype=i,e.prototype.show=function(){return this.comment?this.code:"`"+this.code+"`"},e.prototype.terminator="",i.isAssignable=i.isCallable=function(){return!this.comment},e.prototype.compile=function(t){return sn(this,snSafe(this.literal?entab(this.code,t.indent):this.code))},e}(Node),exports.Require=Require=function(t){function e(t){var e=this instanceof n?this:new n;return e.body=t,e}function n(){}var i=extend$((import$(e,t).displayName="Require",e),t).prototype;return n.prototype=i,e.prototype.children=["body"],e.prototype.compile=function(t){var e,n,i,s,r,o,a,l=this;if(e=function(t,e){switch(!1){case!(t instanceof Key):return t.name;case!(t instanceof Var):return t.value;case!(t instanceof Literal):return t.value;default:return e?l.carp("invalid require! argument"):t}},n=function(n){var i,s,r,o,a,l;return i=function(){switch(!1){case!(n instanceof Prop):return[n.val,n.key];default:return[n,n]}}(),s=i[0],r=i[1],o=e(s),a="String"===toString$.call(o).slice(8,-1)?CopyL(s,Var(nameFromPath(o))):s,r=stripString(e(r,!0)),l=Chain(CopyL(this,Var("require"))).add(Call([Literal("'"+r+"'")])),sn(n,Assign(a,l).compile(t))},null!=this.body.items){for(i=[],s=0,o=(r=this.body.items).length;s<o;++s)a=r[s],i.push(n(a),";\n"+t.indent);return i.pop(),sn.apply(null,[null].concat(slice$.call(i)))}return sn(null,n(this.body))},e}(Node),exports.Util=Util=function(t){function e(t){var e=this instanceof n?this:new n;return e.verb=t,e}function n(){}var i=extend$((import$(e,t).displayName="Util",e),t).prototype;return n.prototype=i,e.prototype.show=Jump.prototype.show,e.prototype.isCallable=YES,e.prototype.compile=function(){return sn(this,util(this.verb))},e.Extends=function(){return Call.make(e("extend"),[arguments[0],arguments[1]])},e}(Node),exports.Vars=Vars=function(t){function e(t){var e=this instanceof n?this:new n;return e.vars=t,e}function n(){}var i=extend$((import$(e,t).displayName="Vars",e),t).prototype;return n.prototype=i,e.prototype.children=["vars"],e.prototype.makeReturn=THIS,e.prototype.compile=function(t,e){var n,i,s,r,o;for(n=0,s=(i=this.vars).length;n<s;++n)r=i[n],o=r.value,r instanceof Var||r.carp("invalid variable declaration"),t.scope.check(o)&&r.carp('redeclaration of "'+o+'"'),t.scope.declare(o,r);return sn(this,Literal("void").compile(t,e))},e}(Node),exports.L=function(t,e,n){return n&&"object"==typeof n&&(n.first_line=t.first_line+1,n.first_column=t.first_column,n.last_line=e.last_line+1,n.last_column=e.last_column,n.line=t.first_line+1,n.column=t.first_column),n},exports.CopyL=CopyL=function(t,e){return e&&"object"==typeof e&&(e.first_line=t.first_line,e.first_column=t.first_column,e.last_line=t.last_line,e.last_column=t.last_column,e.line=t.line,e.column=t.column),e},exports.Box=function(t){return"object"==typeof t?t:new t.constructor(t)},exports.Decl=function(t,e,n){if(!e[0])throw SyntaxError("empty "+t+" on line "+n);return DECLS[t](e)},DECLS={export:function(t){var e,n,i,s,r;for(e=-1,n=Util("out");i=t[++e];)i instanceof Block?t.splice.apply(t,[e--,1].concat(slice$.call(i.lines))):(s=i instanceof Fun&&i.name)?t.splice(e++,0,Assign(Chain(n,[Index(Key(s))]),Var(s))):t[e]=(s=i.varName()||i instanceof Assign&&i.left.varName()||i instanceof Class&&(null!=(r=i.title)?r.varName():void 0))?Assign(Chain(n,[Index(Key(s))]),i):Import(n,i);return Block(t)},import:function(t,e){var n,i,s,r;for(n=0,i=t.length;n<i;++n)s=n,r=t[n],t[s]=Import(Literal("this"),r,e);return Block(t)},importAll:function(t){return this.import(t,!0)},const:function(t){var e,n,i;for(e=0,n=t.length;e<n;++e)i=t[e],"="===i.op||i.carp("invalid constant variable declaration"),i.const=!0;return Block(t)},var:Vars},ref$=Scope.prototype,ref$.READ_ONLY={const:"constant",function:"function",undefined:"undeclared"},ref$.add=function(t,e,n){var i,s;return n&&(i=this.variables[t+"."])&&((s=this.READ_ONLY[i]||this.READ_ONLY[e])?n.carp("redeclaration of "+s+' "'+t+'"'):i===e&&"arg"===e?n.carp('duplicate parameter "'+t+'"'):"upvar"===i&&n.carp('accidental shadow of "'+t+'"'),"arg"===i||"function"===i)?t:(this.variables[t+"."]=e,t)},ref$.get=function(t){return this.variables[t+"."]},ref$.declare=function(t,e,n){var i,s;if(i=this.shared){if(this.check(t))return;s=i}else s=this;return s.add(t,n?"const":"var",e)},ref$.assign=function(t,e){return this.add(t,{value:e})},ref$.temporary=function(t){function e(t){return++t}var n;for(t||(t="ref");"reuse"!==(n=this.variables[t+"$."])&&void 0!==n;)t=t.length<2&&t<"z"?String.fromCharCode(t.charCodeAt()+1):t.replace(/\d*$/,e);return this.add(t+"$","var")},ref$.free=function(t){return this.add(t,"reuse")},ref$.check=function(t,e){var n,i;return(n=this.variables[t+"."])||!e?n:null!=(i=this.parent)?i.check(t,e):void 0},ref$.checkReadOnly=function(t){var e,n,i;return(e=this.READ_ONLY[this.check(t,!0)])?e:((n=this.variables)[i=t+"."]||(n[i]="upvar"),"")},ref$.emit=function(t,e){var n,i,s,r,o,a,l,c,p;n=[],i=[],s=[];for(r in o=this.variables)a=o[r],r=r.slice(0,-1),"var"===a||"const"===a||"reuse"===a?n.push(r,", "):(l=a.value)&&(~(c=entab(l,e)).toString().lastIndexOf("function(",0)?(c instanceof SourceNode?snRemoveLeft(c,8):c=c.slice(8),s.push("function ",r,c,"\n"+e)):i.push(r," = ",c,", "));return p=n.concat(i),p.pop(),s.pop(),p.length>0&&(t=sn.apply(null,[this,e+"var "].concat(slice$.call(p),[";\n",t]))),s.length>0?sn.apply(null,[this,t,"\n"+e].concat(slice$.call(s))):sn(this,t)},UTILS={clone:"function(it){\n  function fun(){} fun.prototype = it;\n  return new fun;\n}",extend:"function(sub, sup){\n  function fun(){} fun.prototype = (sub.superclass = sup).prototype;\n  (sub.prototype = new fun).constructor = sub;\n  if (typeof sup.extended == 'function') sup.extended(sub);\n  return sub;\n}",bind:"function(obj, key, target){\n  return function(){ return (target || obj)[key].apply(obj, arguments) };\n}",import:"function(obj, src){\n  var own = {}.hasOwnProperty;\n  for (var key in src) if (own.call(src, key)) obj[key] = src[key];\n  return obj;\n}",importAll:"function(obj, src){\n  for (var key in src) obj[key] = src[key];\n  return obj;\n}",repeatString:"function(str, n){\n  for (var r = ''; n > 0; (n >>= 1) && (str += str)) if (n & 1) r += str;\n  return r;\n}",repeatArray:"function(arr, n){\n  for (var r = []; n > 0; (n >>= 1) && (arr = arr.concat(arr)))\n    if (n & 1) r.push.apply(r, arr);\n  return r;\n}",in:"function(x, xs){\n  var i = -1, l = xs.length >>> 0;\n  while (++i < l) if (x === xs[i]) return true;\n  return false;\n}",out:"typeof exports != 'undefined' && exports || this",curry:"function(f, bound){\n  var context,\n  _curry = function(args) {\n    return f.length > 1 ? function(){\n      var params = args ? args.concat() : [];\n      context = bound ? context || this : this;\n      return params.push.apply(params, arguments) <\n          f.length && arguments.length ?\n        _curry.call(context, params) : f.apply(context, params);\n    } : f;\n  };\n  return _curry();\n}",flip:"function(f){\n  return curry$(function (x, y) { return f(y, x); });\n}",partialize:"function(f, args, where){\n  var context = this;\n  return function(){\n    var params = slice$.call(arguments), i,\n        len = params.length, wlen = where.length,\n        ta = args ? args.concat() : [], tw = where ? where.concat() : [];\n    for(i = 0; i < len; ++i) { ta[tw[0]] = params[i]; tw.shift(); }\n    return len < wlen && len ?\n      partialize$.apply(context, [f, ta, tw]) : f.apply(context, ta);\n  };\n}",not:"function(x){ return !x; }",compose:"function() {\n  var functions = arguments;\n  return function() {\n    var i, result;\n    result = functions[0].apply(this, arguments);\n    for (i = 1; i < functions.length; ++i) {\n      result = functions[i](result);\n    }\n    return result;\n  };\n}",deepEq:"function(x, y, type){\n  var toString = {}.toString, hasOwnProperty = {}.hasOwnProperty,\n      has = function (obj, key) { return hasOwnProperty.call(obj, key); };\n  var first = true;\n  return eq(x, y, []);\n  function eq(a, b, stack) {\n    var className, length, size, result, alength, blength, r, key, ref, sizeB;\n    if (a == null || b == null) { return a === b; }\n    if (a.__placeholder__ || b.__placeholder__) { return true; }\n    if (a === b) { return a !== 0 || 1 / a == 1 / b; }\n    className = toString.call(a);\n    if (toString.call(b) != className) { return false; }\n    switch (className) {\n      case '[object String]': return a == String(b);\n      case '[object Number]':\n        return a != +a ? b != +b : (a == 0 ? 1 / a == 1 / b : a == +b);\n      case '[object Date]':\n      case '[object Boolean]':\n        return +a == +b;\n      case '[object RegExp]':\n        return a.source == b.source &&\n               a.global == b.global &&\n               a.multiline == b.multiline &&\n               a.ignoreCase == b.ignoreCase;\n    }\n    if (typeof a != 'object' || typeof b != 'object') { return false; }\n    length = stack.length;\n    while (length--) { if (stack[length] == a) { return true; } }\n    stack.push(a);\n    size = 0;\n    result = true;\n    if (className == '[object Array]') {\n      alength = a.length;\n      blength = b.length;\n      if (first) {\n        switch (type) {\n        case '===': result = alength === blength; break;\n        case '<==': result = alength <= blength; break;\n        case '<<=': result = alength < blength; break;\n        }\n        size = alength;\n        first = false;\n      } else {\n        result = alength === blength;\n        size = alength;\n      }\n      if (result) {\n        while (size--) {\n          if (!(result = size in a == size in b && eq(a[size], b[size], stack))){ break; }\n        }\n      }\n    } else {\n      if ('constructor' in a != 'constructor' in b || a.constructor != b.constructor) {\n        return false;\n      }\n      for (key in a) {\n        if (has(a, key)) {\n          size++;\n          if (!(result = has(b, key) && eq(a[key], b[key], stack))) { break; }\n        }\n      }\n      if (result) {\n        sizeB = 0;\n        for (key in b) {\n          if (has(b, key)) { ++sizeB; }\n        }\n        if (first) {\n          if (type === '<<=') {\n            result = size < sizeB;\n          } else if (type === '<==') {\n            result = size <= sizeB\n          } else {\n            result = size === sizeB;\n          }\n        } else {\n          first = false;\n          result = size === sizeB;\n        }\n      }\n    }\n    stack.pop();\n    return result;\n  }\n}",split:"''.split",replace:"''.replace",toString:"{}.toString",join:"[].join",slice:"[].slice",splice:"[].splice"},LEVEL_TOP=0,LEVEL_PAREN=1,LEVEL_LIST=2,LEVEL_COND=3,LEVEL_OP=4,LEVEL_CALL=5,
function(){this["&&"]=this["||"]=this.xor=.2,this[".&."]=this[".^."]=this[".|."]=.3,this["=="]=this["!="]=this["~="]=this["!~="]=this["==="]=this["!=="]=.4,this["<"]=this[">"]=this["<="]=this[">="]=this.of=this.instanceof=.5,this["<<="]=this[">>="]=this["<=="]=this[">=="]=this["++"]=.5,this[".<<."]=this[".>>."]=this[".>>>."]=.6,this["+"]=this["-"]=.7,this["*"]=this["/"]=this["%"]=.8}.call(PREC={unary:.9}),TAB="  ",ID=/^(?!\d)[\w$\xAA-\uFFDC]+$/,SIMPLENUM=/^\d+$/;